

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>analytics_core.analytics.analytics &mdash; ClinicalKnowledgeGraph 1.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> ClinicalKnowledgeGraph
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../INTRO.html">Clinical Knowledge Graph</a></li>
</ul>
<p class="caption"><span class="caption-text">First steps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/getting-started-with-neo4j.html">Getting Started with Neo4j</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/getting-started-with-build.html">Getting Started with the CKG Build</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/connect-to-ckg.html">Connecting to the Clinical Knowledge Graph database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/create-new-user.html">Create a new user in the graph database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/create-new-project.html">Create a new project in the database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/upload-data.html">Upload project experimental data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/data-analysis-config.html">Define data analysis parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/access-report.html">Accessing the analysis report</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/notifications.html">Report notifications</a></li>
</ul>
<p class="caption"><span class="caption-text">Project Report</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../project_report/project-report.html">Generating a project report</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../project_report/project-tabs.html">Project report tabs</a></li>
</ul>
<p class="caption"><span class="caption-text">CKG Builder</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../ckg_builder/ontologies.html">Ontology sources and raw file parsers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ckg_builder/databases.html">Biomedical databases and resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ckg_builder/experiments.html">Parsing experimental data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ckg_builder/graphdb-builder.html">Building the graph database from one Python module</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced_features/import-statistics.html">Clinical Knowledge Graph Statistics: Imports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced_features/graphdb-statistics.html">Clinical Knowledge Graph Statistics: Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced_features/ckg-notebooks.html">Using Jupyter Notebooks with the Clinical Knowledge Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced_features/ckg-queries.html">Retrieving data from the Clinical Knowledge Graph database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced_features/standard-analysis.html">Standardizing the data analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced_features/visualization-plots.html">Visualization plots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced_features/R-interface.html">Python - R interface</a></li>
</ul>
<p class="caption"><span class="caption-text">System Requirements</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../system_require/mac-os.html">Mac OS X requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../system_require/linux.html">Linux requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../system_require/windows.html">Windows requirements</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../src.html">Clinical Knowledge Graph package</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../MANIFEST.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../MANIFEST.html#backers">Backers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../MANIFEST.html#contributing">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../MANIFEST.html#history">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../MANIFEST.html#code-of-conduct">Code of Conduct</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ClinicalKnowledgeGraph</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>analytics_core.analytics.analytics</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for analytics_core.analytics.analytics</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="k">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="k">import</span> <span class="n">TSNE</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="k">import</span> <span class="n">AffinityPropagation</span>
<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="k">import</span> <span class="n">shuffle</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats</span> <span class="k">import</span> <span class="n">multitest</span><span class="p">,</span> <span class="n">anova</span> <span class="k">as</span> <span class="n">aov</span>
<span class="kn">import</span> <span class="nn">dabest</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="k">import</span> <span class="n">factorial</span><span class="p">,</span> <span class="n">betainc</span>
<span class="kn">import</span> <span class="nn">umap</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="k">import</span> <span class="n">preprocessing</span><span class="p">,</span> <span class="n">ensemble</span><span class="p">,</span> <span class="n">cluster</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">pingouin</span> <span class="k">as</span> <span class="nn">pg</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">community</span>
<span class="kn">import</span> <span class="nn">snf</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="k">import</span> <span class="n">spectral_clustering</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="k">import</span> <span class="n">v_measure_score</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">fancyimpute</span> <span class="k">import</span> <span class="n">KNN</span>
<span class="kn">import</span> <span class="nn">kmapper</span> <span class="k">as</span> <span class="nn">km</span>
<span class="kn">from</span> <span class="nn">analytics_core</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">analytics_core.analytics</span> <span class="k">import</span> <span class="n">wgcnaAnalysis</span> <span class="k">as</span> <span class="n">wgcna</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">statsmodels.formula.api</span> <span class="k">import</span> <span class="n">ols</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="k">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">rpy2</span> <span class="k">import</span> <span class="n">robjects</span> <span class="k">as</span> <span class="n">ro</span>
    <span class="kn">from</span> <span class="nn">rpy2.robjects.packages</span> <span class="k">import</span> <span class="n">importr</span>
    <span class="kn">from</span> <span class="nn">rpy2.robjects</span> <span class="k">import</span> <span class="n">pandas2ri</span>
    <span class="kn">import</span> <span class="nn">rpy2.robjects.numpy2ri</span>

    <span class="n">pandas2ri</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">ro</span><span class="o">.</span><span class="n">r</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">)</span>
    <span class="n">stats_r</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s1">&#39;stats&#39;</span><span class="p">)</span>
    <span class="n">samr</span> <span class="o">=</span> <span class="n">importr</span><span class="p">(</span><span class="s1">&#39;samr&#39;</span><span class="p">)</span>
    <span class="n">r_installation</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">r_installation</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R functions will not work. Module Rpy2 not installed.&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="transform_into_wide_format"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.transform_into_wide_format">[docs]</a><span class="k">def</span> <span class="nf">transform_into_wide_format</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function converts a Pandas DataFrame from long to wide format using pandas pivot_table() function.</span>

<span class="sd">    :param data: long-format Pandas DataFrame</span>
<span class="sd">    :param list index: columns that will be converted into the index</span>
<span class="sd">    :param str columns: column name whose unique values will become the new column names</span>
<span class="sd">    :param str values: column to aggregate</span>
<span class="sd">    :param list extra: additional columns to be kept as columns</span>
<span class="sd">    :return: Wide-format pandas DataFrame</span>

<span class="sd">    Example::</span>

<span class="sd">        result = transform_into_wide_format(df, index=&#39;index&#39;, columns=&#39;x&#39;, values=&#39;y&#39;, extra=&#39;group&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">]</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">extra</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="n">extra_cols</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">extra</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extra_cols</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="transform_into_long_format"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.transform_into_long_format">[docs]</a><span class="k">def</span> <span class="nf">transform_into_long_format</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">drop_columns</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a Pandas DataDrame from wide to long format using pd.melt() function.</span>

<span class="sd">    :param data: wide-format Pandas DataFrame</span>
<span class="sd">    :param list drop_columns: columns to be deleted</span>
<span class="sd">    :param group: column(s) to use as identifier variables</span>
<span class="sd">    :type group: str or list</span>
<span class="sd">    :param list columns: names to use for the 1)variable column, and for the 2)value column</span>
<span class="sd">    :return: Long-format Pandas DataFrame.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = transform_into_long_format(df, drop_columns=[&#39;sample&#39;, &#39;subject&#39;], group=&#39;group&#39;, columns=[&#39;name&#39;,&#39;y&#39;])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">long_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">long_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value_name</span><span class="o">=</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">long_data</span> <span class="o">=</span> <span class="n">long_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="n">long_data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span>

    <span class="k">return</span> <span class="n">long_data</span></div>

<div class="viewcode-block" id="get_ranking_with_markers"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.get_ranking_with_markers">[docs]</a><span class="k">def</span> <span class="nf">get_ranking_with_markers</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">drop_columns</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">list_markers</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates a long-format dataframe with features and values to be plotted together with disease biomarker annotations.</span>

<span class="sd">    :param data: wide-format Pandas DataFrame with samples as rows and features as columns</span>
<span class="sd">    :param list drop_columns: columns to be deleted</span>
<span class="sd">    :param str group: column to use as identifier variables</span>
<span class="sd">    :param list columns: names to use for the 1)variable column, and for the 2)value column</span>
<span class="sd">    :param list list_markers: list of features from data, known to be markers associated to disease.</span>
<span class="sd">    :param dict annotation: markers, from list_markers, and associated diseases.</span>
<span class="sd">    :return: Long-format pandas DataFrame with group identifiers as rows and columns: &#39;name&#39; (identifier), &#39;y&#39; (LFQ intensity), &#39;symbol&#39; and &#39;size&#39;.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = get_ranking_with_markers(data, drop_columns=[&#39;sample&#39;, &#39;subject&#39;], group=&#39;group&#39;, columns=[&#39;name&#39;, &#39;y&#39;], list_markers, annotation={})</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">long_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">long_data</span> <span class="o">=</span> <span class="n">transform_into_long_format</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">drop_columns</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">long_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">list_markers</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">long_data</span> <span class="o">=</span> <span class="n">long_data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="n">long_data</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">17</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">list_markers</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">long_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
            <span class="n">long_data</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">25</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">list_markers</span> <span class="k">else</span> <span class="mi">7</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">long_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
            <span class="n">long_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="s1">&#39; marker in &#39;</span><span class="o">+</span><span class="n">annotation</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">annotation</span> <span class="k">else</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">long_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>

    <span class="k">return</span> <span class="n">long_data</span></div>


<div class="viewcode-block" id="extract_number_missing"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.extract_number_missing">[docs]</a><span class="k">def</span> <span class="nf">extract_number_missing</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">min_valid</span><span class="p">,</span> <span class="n">drop_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">],</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Counts how many valid values exist in each column and filters column labels with more valid values than the minimum threshold defined.</span>

<span class="sd">    :param data: pandas DataFrame with group as rows and protein identifier as column.</span>
<span class="sd">    :param str group: column label containing group identifiers. If None, number of valid values is counted across all samples, otherwise is counted per unique group identifier.</span>
<span class="sd">    :param int min_valid: minimum number of valid values to be filtered.</span>
<span class="sd">    :param list drop_columns: column labels to be dropped.</span>
<span class="sd">    :return: List of column labels above the threshold.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = extract_number_missing(data, min_valid=3, drop_cols=[&#39;sample&#39;], group=&#39;group&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">data</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_valid</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="n">groups</span><span class="o">&gt;=</span><span class="n">min_valid</span><span class="p">]</span>

    <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">groups</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span></div>

<div class="viewcode-block" id="extract_percentage_missing"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.extract_percentage_missing">[docs]</a><span class="k">def</span> <span class="nf">extract_percentage_missing</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">missing_max</span><span class="p">,</span> <span class="n">drop_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">],</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts ratio of missing/valid values in each column and filters column labels with lower ratio than the minimum threshold defined.</span>

<span class="sd">    :param data: pandas dataframe with group as rows and protein identifier as column.</span>
<span class="sd">    :param str group: column label containing group identifiers. If None, ratio is calculated across all samples, otherwise is calculated per unique group identifier.</span>
<span class="sd">    :param float missing_max: maximum ratio of missing/valid values to be filtered.</span>
<span class="sd">    :return: List of column labels below the threshold.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = extract_percentage_missing(data, missing_max=0.3, drop_cols=[&#39;sample&#39;], group=&#39;group&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">missing_max</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="n">groups</span><span class="o">&lt;=</span><span class="n">missing_max</span><span class="p">]</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">groups</span></div>

<div class="viewcode-block" id="imputation_KNN"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.imputation_KNN">[docs]</a><span class="k">def</span> <span class="nf">imputation_KNN</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">drop_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">],</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">alone</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    k-Nearest Neighbors imputation for pandas dataframes with missing data. For more information visit https://github.com/iskandr/fancyimpute/blob/master/fancyimpute/knn.py.</span>

<span class="sd">    :param data: pandas dataframe with samples as rows and protein identifiers as columns (with additional columns &#39;group&#39;, &#39;sample&#39; and &#39;subject&#39;).</span>
<span class="sd">    :param str group: column label containing group identifiers.</span>
<span class="sd">    :param list drop_cols: column labels to be dropped. Final dataframe should only have gene/protein/etc identifiers as columns.</span>
<span class="sd">    :param float cutoff: minimum ratio of missing/valid values required to impute in each column.</span>
<span class="sd">    :param boolean alone: if True removes all columns with any missing values.</span>
<span class="sd">    :return: Pandas dataframe with samples as rows and protein identifiers as columns.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = imputation_KNN(data, drop_cols=[&#39;group&#39;, &#39;sample&#39;, &#39;subject&#39;], group=&#39;group&#39;, cutoff=0.6, alone = True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">_get_numeric_data</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
    <span class="n">value_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drop_cols</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">missDf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">==</span><span class="n">g</span><span class="p">,</span> <span class="n">value_cols</span><span class="p">]</span>
        <span class="n">missDf</span> <span class="o">=</span> <span class="n">missDf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">missDf</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">cutoff</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">missDf</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">missDf</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">X_trans</span> <span class="o">=</span> <span class="n">KNN</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">missingdata_df</span> <span class="o">=</span> <span class="n">missDf</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">dfm</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_trans</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">missDf</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">missingdata_df</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dfm</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alone</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="imputation_mixed_norm_KNN"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.imputation_mixed_norm_KNN">[docs]</a><span class="k">def</span> <span class="nf">imputation_mixed_norm_KNN</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">],</span> <span class="n">shift</span> <span class="o">=</span> <span class="mf">1.8</span><span class="p">,</span> <span class="n">nstd</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Missing values are replaced in two steps: 1) using k-Nearest Neighbors we impute protein columns with a higher ratio of missing/valid values than the defined cutoff, \</span>
<span class="sd">    2) the remaining missing values are replaced by random numbers that are drawn from a normal distribution.</span>

<span class="sd">    :param data: pandas dataframe with samples as rows and protein identifiers as columns (with additional columns &#39;group&#39;, &#39;sample&#39; and &#39;subject&#39;).</span>
<span class="sd">    :param str group: column label containing group identifiers.</span>
<span class="sd">    :param list index_cols: list of column labels to be set as dataframe index.</span>
<span class="sd">    :param float shift: specifies the amount by which the distribution used for the random numbers is shifted downwards. This is in units of the \</span>
<span class="sd">                        standard deviation of the valid data.</span>
<span class="sd">    :param float nstd: defines the width of the Gaussian distribution relative to the standard deviation of measured values. \</span>
<span class="sd">                        A value of 0.5 would mean that the width of the distribution used for drawing random numbers is half of the standard deviation of the data.</span>
<span class="sd">    :param float cutoff: minimum ratio of missing/valid values required to impute in each column.</span>
<span class="sd">    :return: Pandas dataframe with samples as rows and protein identifiers as columns.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = imputation_mixed_norm_KNN(data, index_cols=[&#39;group&#39;, &#39;sample&#39;, &#39;subject&#39;], shift = 1.8, nstd = 0.3, group=&#39;group&#39;, cutoff=0.6)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">imputation_KNN</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">drop_cols</span><span class="o">=</span><span class="n">index_cols</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">alone</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">imputation_normal_distribution</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">index_cols</span><span class="o">=</span><span class="n">index_cols</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span> <span class="n">nstd</span><span class="o">=</span><span class="n">nstd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="imputation_normal_distribution"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.imputation_normal_distribution">[docs]</a><span class="k">def</span> <span class="nf">imputation_normal_distribution</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">],</span> <span class="n">shift</span> <span class="o">=</span> <span class="mf">1.8</span><span class="p">,</span> <span class="n">nstd</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Missing values will be replaced by random numbers that are drawn from a normal distribution. The imputation is done for each sample (across all proteins) separately.</span>
<span class="sd">    For more information visit http://www.coxdocs.org/doku.php?id=perseus:user:activities:matrixprocessing:imputation:replacemissingfromgaussian.</span>

<span class="sd">    :param data: pandas dataframe with samples as rows and protein identifiers as columns (with additional columns &#39;group&#39;, &#39;sample&#39; and &#39;subject&#39;).</span>
<span class="sd">    :param list index_cols: list of column labels to be set as dataframe index.</span>
<span class="sd">    :param float shift: specifies the amount by which the distribution used for the random numbers is shifted downwards. This is in units of the standard deviation of the valid data.</span>
<span class="sd">    :param float nstd: defines the width of the Gaussian distribution relative to the standard deviation of measured values. A value of 0.5 would mean that the width of the distribution used for drawing random numbers is half of the standard deviation of the data.</span>
<span class="sd">    :return: Pandas dataframe with samples as rows and protein identifiers as columns.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = imputation_normal_distribution(data, index_cols=[&#39;group&#39;, &#39;sample&#39;, &#39;subject&#39;], shift = 1.8, nstd = 0.3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">112736</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">index_cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index_cols</span><span class="p">)</span>
    <span class="n">data_imputed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="n">null_columns</span> <span class="o">=</span> <span class="n">data_imputed</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">data_imputed</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">null_columns</span><span class="p">:</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">data_imputed</span><span class="p">[</span><span class="n">data_imputed</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">data_imputed</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">data_imputed</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">std</span><span class="o">*</span><span class="n">nstd</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">-</span> <span class="p">(</span><span class="n">std</span><span class="o">*</span><span class="n">shift</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">std</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mu</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">))</span>

        <span class="n">data_imputed</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">data_imputed</span><span class="o">.</span><span class="n">T</span></div>


<div class="viewcode-block" id="polish_median_normalization"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.polish_median_normalization">[docs]</a><span class="k">def</span> <span class="nf">polish_median_normalization</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">max_iter</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function iteratively normalizes each sample and each feature to its median until medians converge.</span>

<span class="sd">    :param data:</span>
<span class="sd">    :param int max_iter: number of maximum iterations to prevent infinite loop.</span>
<span class="sd">    :return: Pandas dataframe.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = polish_median_normalization(data, max_iter = 10)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mediandf</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>
        <span class="n">col_median</span> <span class="o">=</span> <span class="n">mediandf</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">row_median</span> <span class="o">=</span> <span class="n">mediandf</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row_median</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">col_median</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">mediandf</span> <span class="o">=</span> <span class="n">mediandf</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">row_median</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mediandf</span> <span class="o">=</span> <span class="n">mediandf</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">col_median</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">normData</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">mediandf</span>

    <span class="k">return</span> <span class="n">normData</span></div>

<div class="viewcode-block" id="quantile_normalization"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.quantile_normalization">[docs]</a><span class="k">def</span> <span class="nf">quantile_normalization</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies quantile normalization to each column in pandas dataframe.</span>

<span class="sd">    :param data: pandas dataframe with features as rows and samples as columns.</span>
<span class="sd">    :return: Pandas dataframe</span>

<span class="sd">    Example::</span>

<span class="sd">        result = quantile_normalization(data)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rank_mean</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">normdf</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">rank_mean</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">normdf</span></div>

<div class="viewcode-block" id="linear_normalization"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.linear_normalization">[docs]</a><span class="k">def</span> <span class="nf">linear_normalization</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;l1&quot;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function scales input data to a unit norm. For more information visit https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.normalize.html.</span>

<span class="sd">    :param data: pandas dataframe with samples as rows and features as columns.</span>
<span class="sd">    :param str method: norm to use to normalize each non-zero sample or non-zero feature (depends on axis).</span>
<span class="sd">    :param int axis: axis used to normalize the data along. If 1, independently normalize each sample, otherwise (if 0) normalize each feature.</span>
<span class="sd">    :return: Pandas dataframe</span>

<span class="sd">    Example::</span>

<span class="sd">        result = linear_normalization(data, method = &quot;l1&quot;, axis = 0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">normvalues</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">normdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">normvalues</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">normdf</span></div>

<div class="viewcode-block" id="remove_group"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.remove_group">[docs]</a><span class="k">def</span> <span class="nf">remove_group</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes column with label &#39;group&#39;.</span>

<span class="sd">    :param data: pandas dataframe with one column labelled &#39;group&#39;</span>
<span class="sd">    :return: Pandas dataframe</span>

<span class="sd">    Example::</span>

<span class="sd">        result = remove_group(data)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;group&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="calculate_coefficient_variation"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.calculate_coefficient_variation">[docs]</a><span class="k">def</span> <span class="nf">calculate_coefficient_variation</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the coefficient of variation, the ratio of the biased standard deviation to the mean, in percentage. For more information visit https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.variation.html.</span>

<span class="sd">    :param ndarray values: numpy array</span>
<span class="sd">    :return: The calculated variation along rows.</span>
<span class="sd">    :rtype: ndarray</span>

<span class="sd">    Example::</span>

<span class="sd">        result = calculate_coefficient_variation()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cv</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">variation</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">*</span><span class="mi">100</span>

    <span class="k">return</span> <span class="n">cv</span></div>

<div class="viewcode-block" id="get_coefficient_variation"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.get_coefficient_variation">[docs]</a><span class="k">def</span> <span class="nf">get_coefficient_variation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">drop_columns</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts the coefficients of variation in each group.</span>

<span class="sd">    :param data: pandas dataframe with samples as rows and protein identifiers as columns (with additional columns &#39;group&#39;, &#39;sample&#39; and &#39;subject&#39;).</span>
<span class="sd">    :param list drop_columns: column labels to be dropped from the dataframe</span>
<span class="sd">    :param str group: column label containing group identifiers.</span>
<span class="sd">    :param list columns: names to use for the variable column(s), and for the value column(s)</span>
<span class="sd">    :return: Pandas dataframe with columns &#39;name&#39; (protein identifier), &#39;x&#39; (coefficient of variation), &#39;y&#39; (mean) and &#39;group&#39;.</span>

<span class="sd">    Exmaple::</span>

<span class="sd">        result = get_coefficient_variation(data, drop_columns=[&#39;sample&#39;, &#39;subject&#39;], group=&#39;group&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">formated_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cvs</span> <span class="o">=</span> <span class="n">formated_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">calculate_coefficient_variation</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">formated_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">cvs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cvs</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">gcvs</span> <span class="o">=</span> <span class="n">cvs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">ints</span> <span class="o">=</span> <span class="n">formated_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">tdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">cols</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span><span class="n">gcvs</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="n">ints</span><span class="p">})</span>
        <span class="n">tdf</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

        <span class="k">if</span> <span class="n">cvs_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">cvs_df</span> <span class="o">=</span> <span class="n">tdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cvs_df</span> <span class="o">=</span> <span class="n">cvs_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tdf</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cvs_df</span></div>


<div class="viewcode-block" id="get_proteomics_measurements_ready"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.get_proteomics_measurements_ready">[docs]</a><span class="k">def</span> <span class="nf">get_proteomics_measurements_ready</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">index_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">],</span> <span class="n">drop_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">],</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="n">extra_identifier</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">imputation</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;distribution&#39;</span><span class="p">,</span> <span class="n">missing_method</span> <span class="o">=</span> <span class="s1">&#39;percentage&#39;</span><span class="p">,</span> <span class="n">missing_per_group</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">missing_max</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">min_valid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">value_col</span><span class="o">=</span><span class="s1">&#39;LFQ_intensity&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processes proteomics data extracted from the database: 1) filter proteins with high number of missing values (&gt; missing_max or min_valid), 2) impute missing values.</span>
<span class="sd">    For more information on imputation method visit http://www.coxdocs.org/doku.php?id=perseus:user:activities:matrixprocessing:filterrows:filtervalidvaluesrows.</span>

<span class="sd">    :param df: long-format pandas dataframe with columns &#39;group&#39;, &#39;sample&#39;, &#39;subject&#39;, &#39;identifier&#39; (protein), &#39;name&#39; (gene) and &#39;LFQ_intensity&#39;.</span>
<span class="sd">    :param list index_cols: column labels to be be kept as index identifiers.</span>
<span class="sd">    :param list drop_cols: column labels to be dropped from the dataframe.</span>
<span class="sd">    :param str group: column label containing group identifiers.</span>
<span class="sd">    :param str identifier: column label containing feature identifiers.</span>
<span class="sd">    :param str extra_identifier: column label containing additional protein identifiers (e.g. gene names).</span>
<span class="sd">    :param bool imputation: if True performs imputation of missing values.</span>
<span class="sd">    :param str method:  method for missing values imputation (&#39;KNN&#39;, &#39;distribuition&#39;, or &#39;mixed&#39;)</span>
<span class="sd">    :param str missing_method: defines which expression rows are counted to determine if a column has enough valid values to survive the filtering process.</span>
<span class="sd">    :param bool missing_per_group: if True filter proteins based on valid values per group; if False filter across all samples.</span>
<span class="sd">    :param float missing_max: maximum ratio of missing/valid values to be filtered.</span>
<span class="sd">    :param int min_valid: minimum number of valid values to be filtered.</span>
<span class="sd">    :param str value_col: column label containing expression values.</span>
<span class="sd">    :return: Pandas dataframe with samples as rows and protein identifiers (UniprotID~GeneName) as columns (with additional columns &#39;group&#39;, &#39;sample&#39; and &#39;subject&#39;).</span>

<span class="sd">    Example 1::</span>

<span class="sd">        result = get_proteomics_measurements_ready(df, index_cols=[&#39;group&#39;, &#39;sample&#39;, &#39;subject&#39;], drop_cols=[&#39;sample&#39;], group=&#39;group&#39;, identifier=&#39;identifier&#39;, extra_identifier=&#39;name&#39;, imputation = True, method = &#39;distribution&#39;, missing_method = &#39;percentage&#39;, missing_per_group=True, missing_max = 0.3, value_col=&#39;LFQ_intensity&#39;)</span>

<span class="sd">    Example 2::</span>

<span class="sd">        result = get_proteomics_measurements_ready(df, index_cols=[&#39;group&#39;, &#39;sample&#39;, &#39;subject&#39;], drop_cols=[&#39;sample&#39;], group=&#39;group&#39;, identifier=&#39;identifier&#39;, extra_identifier=&#39;name&#39;, imputation = True, method = &#39;mixed&#39;, missing_method = &#39;at_least_x&#39;, missing_per_group=False, min_valid=5, value_col=&#39;LFQ_intensity&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index_cols</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">extra_identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_identifier</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">extra_identifier</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;~&quot;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">value_col</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="n">index_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;index&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">aux</span> <span class="o">=</span> <span class="n">index_cols</span>
    <span class="k">if</span> <span class="n">missing_per_group</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">missing_method</span> <span class="o">==</span> <span class="s1">&#39;at_least_x&#39;</span><span class="p">:</span>
        <span class="n">aux</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extract_number_missing</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">min_valid</span><span class="p">,</span> <span class="n">drop_cols</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">missing_method</span> <span class="o">==</span> <span class="s1">&#39;percentage&#39;</span><span class="p">:</span>
        <span class="n">aux</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extract_percentage_missing</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>  <span class="n">missing_max</span><span class="p">,</span> <span class="n">drop_cols</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">))</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">aux</span><span class="p">))]</span>
    <span class="k">if</span> <span class="n">imputation</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;KNN&quot;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">imputation_KNN</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;distribution&quot;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">imputation_normal_distribution</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="mf">1.8</span><span class="p">,</span> <span class="n">nstd</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mixed&#39;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">imputation_mixed_norm_KNN</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="get_clinical_measurements_ready"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.get_clinical_measurements_ready">[docs]</a><span class="k">def</span> <span class="nf">get_clinical_measurements_ready</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">subject_id</span><span class="o">=</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="n">sample_id</span><span class="o">=</span><span class="s1">&#39;biological_sample&#39;</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;clinical_variable&#39;</span><span class="p">],</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">],</span> <span class="n">imputation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">imputation_method</span><span class="o">=</span><span class="s1">&#39;KNN&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processes clinical data extracted from the database by converting dataframe to wide-format and imputing missing values.</span>

<span class="sd">    :param df: long-format pandas dataframe with columns &#39;group&#39;, &#39;biological_sample&#39;, &#39;subject&#39;, &#39;clinical_variable&#39;, &#39;value&#39;.</span>
<span class="sd">    :param str subject_id: column label containing subject identifiers.</span>
<span class="sd">    :param str sample_id: column label containing biological sample identifiers.</span>
<span class="sd">    :param str group_id: column label containing group identifiers.</span>
<span class="sd">    :param list columns: column name whose unique values will become the new column names</span>
<span class="sd">    :param str values: column label containing clinical variable values.</span>
<span class="sd">    :param list extra: additional column labels to be kept as columns</span>
<span class="sd">    :param bool imputation: if True performs imputation of missing values.</span>
<span class="sd">    :param str imputation_method: method for missing values imputation (&#39;KNN&#39;, &#39;distribuition&#39;, or &#39;mixed&#39;).</span>
<span class="sd">    :return: Pandas dataframe with samples as rows and clinical variables as columns (with additional columns &#39;group&#39;, &#39;subject&#39; and &#39;biological_sample&#39;).</span>

<span class="sd">    Example::</span>

<span class="sd">        result = get_clinical_measurements_ready(df, subject_id=&#39;subject&#39;, sample_id=&#39;biological_sample&#39;, group_id=&#39;group&#39;, columns=[&#39;clinical_variable&#39;], values=&#39;values&#39;, extra=[&#39;group&#39;], imputation=True, imputation_method=&#39;KNN&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">subject_id</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">]</span>
    <span class="n">drop_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">subject_id</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">]</span>
    <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_id</span><span class="p">)</span>

    <span class="n">processed_df</span> <span class="o">=</span> <span class="n">transform_into_wide_format</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">extra</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">imputation</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">imputation_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;knn&quot;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">imputation_KNN</span><span class="p">(</span><span class="n">processed_df</span><span class="p">,</span> <span class="n">drop_cols</span><span class="o">=</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">imputation_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;distribution&quot;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">imputation_normal_distribution</span><span class="p">(</span><span class="n">processed_df</span><span class="p">,</span> <span class="n">index_cols</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">imputation_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mixed&#39;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">imputation_mixed_norm_KNN</span><span class="p">(</span><span class="n">processed_df</span><span class="p">,</span><span class="n">index_cols</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group_id</span><span class="p">)</span>

    <span class="c1">#df = df.set_index(index)</span>

    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="get_summary_data_matrix"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.get_summary_data_matrix">[docs]</a><span class="k">def</span> <span class="nf">get_summary_data_matrix</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns some statistics on the data matrix provided.</span>

<span class="sd">    :param data: pandas dataframe.</span>
<span class="sd">    :return: dictionary with the type of statistics as key and the statistic as value in the shape of a pandas data frame</span>

<span class="sd">    Example::</span>

<span class="sd">        result = get_summary_data_matrix(data)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;Data Matrix Shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Rows&quot;</span><span class="p">,</span> <span class="s2">&quot;Columns&quot;</span><span class="p">])</span>
    <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;Stats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">summary</span></div>


<div class="viewcode-block" id="check_normality"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.check_normality">[docs]</a><span class="k">def</span> <span class="nf">check_normality</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks whether columns (features) in the provided matrix follow a normal distribution (Requires at least 8 rows). Uses</span>
<span class="sd">    Pigouin test Normality: https://pingouin-stats.org/generated/pingouin.normality.html</span>

<span class="sd">    :param data: pandas dataframe.</span>
<span class="sd">    :return: a pandas data frame with features as rows, test statistic, pvalue, true/false normally distributed. None if</span>
<span class="sd">    number of rows below 8.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = check_normality(data)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">test_normality</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">test_normality</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">normality</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;normaltest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">test_normality</span></div>

<div class="viewcode-block" id="run_pca"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_pca">[docs]</a><span class="k">def</span> <span class="nf">run_pca</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">drop_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">],</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs principal component analysis and returns the values of each component for each sample and each protein, and the loadings for each protein. \</span>
<span class="sd">    For information visit https://scikit-learn.org/stable/modules/generated/sklearn.decomposition.PCA.html.</span>

<span class="sd">    :param data: pandas dataframe with samples as rows and protein identifiers as columns (with additional columns &#39;group&#39;, &#39;sample&#39; and &#39;subject&#39;).</span>
<span class="sd">    :param list drop_cols: column labels to be dropped from the dataframe.</span>
<span class="sd">    :param str group: column label containing group identifiers.</span>
<span class="sd">    :param int components: number of components to keep.</span>
<span class="sd">    :param bool dropna: if True removes all columns with any missing values.</span>
<span class="sd">    :return: Two dictionaries: 1) two pandas dataframes (first one with components values, the second with the components vectors for each protein), 2) xaxis and yaxis titles with components loadings for plotly.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = run_pca(data, drop_cols=[&#39;sample&#39;, &#39;subject&#39;], group=&#39;group&#39;, components=2, dropna=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">112736</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">([</span><span class="s1">&#39;number&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">dropna</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">components</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">var_exp</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span>
        <span class="n">loadings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_</span><span class="p">))</span>
        <span class="n">loadings</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">loadings</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="n">loadings</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">loadings</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">loadings</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">loadings</span> <span class="o">=</span> <span class="n">loadings</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x_title&quot;</span><span class="p">:</span><span class="s2">&quot;PC1&quot;</span><span class="o">+</span><span class="s2">&quot; (</span><span class="si">{0:.2f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_exp</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="s2">&quot;y_title&quot;</span><span class="p">:</span><span class="s2">&quot;PC2&quot;</span><span class="o">+</span><span class="s2">&quot; (</span><span class="si">{0:.2f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_exp</span><span class="p">[</span><span class="mi">1</span><span class="p">])}</span>
        <span class="k">if</span> <span class="n">components</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">resultDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>
            <span class="n">resultDf</span> <span class="o">=</span> <span class="n">resultDf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">resultDf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">components</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;z_title&quot;</span><span class="p">:</span><span class="s2">&quot;PC3&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">var_exp</span><span class="p">[</span><span class="mi">2</span><span class="p">])})</span>
            <span class="n">resultDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">resultDf</span> <span class="o">=</span> <span class="n">resultDf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">components</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="n">resultDf</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
            <span class="n">resultDf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span>

        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;pca&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">resultDf</span><span class="p">,</span> <span class="n">loadings</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">args</span></div>

<div class="viewcode-block" id="run_tsne"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_tsne">[docs]</a><span class="k">def</span> <span class="nf">run_tsne</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">drop_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">],</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">perplexity</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s1">&#39;pca&#39;</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs t-distributed Stochastic Neighbor Embedding analysis. For more information visit https://scikit-learn.org/stable/modules/generated/sklearn.manifold.TSNE.html.</span>

<span class="sd">    :param data: pandas dataframe with samples as rows and protein identifiers as columns (with additional columns &#39;group&#39;, &#39;sample&#39; and &#39;subject&#39;).</span>
<span class="sd">    :param list drop_cols: column labels to be dropped from the dataframe.</span>
<span class="sd">    :param str group: column label containing group identifiers.</span>
<span class="sd">    :param int components: dimension of the embedded space.</span>
<span class="sd">    :param int perplexity: related to the number of nearest neighbors that is used in other manifold learning algorithms. Consider selecting a value between 5 and 50.</span>
<span class="sd">    :param int n_iter: maximum number of iterations for the optimization (at least 250).</span>
<span class="sd">    :param str init: initialization of embedding (&#39;random&#39;, &#39;pca&#39; or numpy array of shape n_samples x n_components).</span>
<span class="sd">    :param bool dropna: if True removes all columns with any missing values.</span>
<span class="sd">    :return: Two dictionaries: 1) pandas dataframe with embedding vectors, 2) xaxis and yaxis titles for plotly.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = run_tsne(data, drop_cols=[&#39;sample&#39;, &#39;subject&#39;], group=&#39;group&#39;, components=2, perplexity=40, n_iter=1000, init=&#39;pca&#39;, dropna=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dropna</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">([</span><span class="s1">&#39;number&#39;</span><span class="p">])</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">components</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">perplexity</span><span class="o">=</span><span class="n">perplexity</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x_title&quot;</span><span class="p">:</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span><span class="s2">&quot;y_title&quot;</span><span class="p">:</span><span class="s2">&quot;C2&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">components</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">resultDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>
            <span class="n">resultDf</span> <span class="o">=</span> <span class="n">resultDf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">resultDf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">components</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;z_title&quot;</span><span class="p">:</span><span class="s2">&quot;C3&quot;</span><span class="p">})</span>
            <span class="n">resultDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">resultDf</span> <span class="o">=</span> <span class="n">resultDf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">4</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="n">resultDf</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
            <span class="n">resultDf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;tsne&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resultDf</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">args</span></div>

<div class="viewcode-block" id="run_umap"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_umap">[docs]</a><span class="k">def</span> <span class="nf">run_umap</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">drop_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">],</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs Uniform Manifold Approximation and Projection. For more information vist https://umap-learn.readthedocs.io.</span>

<span class="sd">    :param data: pandas dataframe with samples as rows and protein identifiers as columns (with additional columns &#39;group&#39;, &#39;sample&#39; and &#39;subject&#39;).</span>
<span class="sd">    :param list drop_cols: column labels to be dropped from the dataframe.</span>
<span class="sd">    :param str group: column label containing group identifiers.</span>
<span class="sd">    :param int n_neighbors: number of neighboring points used in local approximations of manifold structure.</span>
<span class="sd">    :param float min_dist: controls how tightly the embedding is allowed compress points together.</span>
<span class="sd">    :param str metric: metric used to measure distance in the input space.</span>
<span class="sd">    :param bool dropna: if True removes all columns with any missing values.</span>
<span class="sd">    :return: Two dictionaries: 1) pandas dataframe with embedding of the training data in low-dimensional space, 2) xaxis and yaxis titles for plotly.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = run_umap(data, drop_cols=[&#39;sample&#39;, &#39;subject&#39;], group=&#39;group&#39;, n_neighbors=10, min_dist=0.3, metric=&#39;cosine&#39;, dropna=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dropna</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">([</span><span class="s1">&#39;number&#39;</span><span class="p">])</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span> <span class="n">metric</span><span class="p">)</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x_title&quot;</span><span class="p">:</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span><span class="s2">&quot;y_title&quot;</span><span class="p">:</span><span class="s2">&quot;C2&quot;</span><span class="p">}</span>
        <span class="n">resultDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">resultDf</span> <span class="o">=</span> <span class="n">resultDf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resultDf</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="n">resultDf</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
        <span class="n">resultDf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;umap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resultDf</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">args</span></div>

<div class="viewcode-block" id="calculate_correlations"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.calculate_correlations">[docs]</a><span class="k">def</span> <span class="nf">calculate_correlations</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates a Spearman (nonparametric) or a Pearson (parametric) correlation coefficient and p-value to test for non-correlation.</span>

<span class="sd">    :param ndarray x: array 1</span>
<span class="sd">    :param ndarray y: array 2</span>
<span class="sd">    :param str method: chooses which kind of correlation method to run</span>
<span class="sd">    :return: Tuple with two floats, correlation coefficient and two-tailed p-value.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = calculate_correlations(x, y, method=&#39;pearson&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;pearson&quot;</span><span class="p">:</span>
        <span class="n">coefficient</span><span class="p">,</span> <span class="n">pvalue</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;spearman&quot;</span><span class="p">:</span>
        <span class="n">coefficient</span><span class="p">,</span> <span class="n">pvalue</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">spearmanr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">coefficient</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">)</span></div>

<div class="viewcode-block" id="apply_pvalue_fdrcorrection"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.apply_pvalue_fdrcorrection">[docs]</a><span class="k">def</span> <span class="nf">apply_pvalue_fdrcorrection</span><span class="p">(</span><span class="n">pvalues</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;indep&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs p-value correction for false discovery rate. For more information visit https://www.statsmodels.org/devel/generated/statsmodels.stats.multitest.fdrcorrection.html.</span>

<span class="sd">    :param ndarray pvalues: et of p-values of the individual tests.</span>
<span class="sd">    :param float alpha: error rate.</span>
<span class="sd">    :param str method: method of p-value correction (&#39;indep&#39;, &#39;negcorr&#39;).</span>
<span class="sd">    :return: Tuple with two arrays, boolen for rejecting H0 hypothesis and float for adjusted p-value.</span>

<span class="sd">    Exmaple::</span>

<span class="sd">        result = apply_pvalue_fdrcorrection(pvalues, alpha=0.05, method=&#39;indep&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rejected</span><span class="p">,</span> <span class="n">padj</span> <span class="o">=</span> <span class="n">multitest</span><span class="o">.</span><span class="n">fdrcorrection</span><span class="p">(</span><span class="n">pvalues</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">rejected</span><span class="p">,</span> <span class="n">padj</span><span class="p">)</span></div>

<div class="viewcode-block" id="apply_pvalue_twostage_fdrcorrection"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.apply_pvalue_twostage_fdrcorrection">[docs]</a><span class="k">def</span> <span class="nf">apply_pvalue_twostage_fdrcorrection</span><span class="p">(</span><span class="n">pvalues</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bh&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Iterated two stage linear step-up procedure with estimation of number of true hypotheses. For more information visit https://www.statsmodels.org/dev/generated/statsmodels.stats.multitest.fdrcorrection_twostage.html.</span>

<span class="sd">    :param ndarray pvalues: et of p-values of the individual tests.</span>
<span class="sd">    :param float alpha: error rate.</span>
<span class="sd">    :param str method: method of p-value correction (&#39;bky&#39;, &#39;bh&#39;).</span>
<span class="sd">    :return: Tuple with two arrays, boolen for rejecting H0 hypothesis and float for adjusted p-value.</span>

<span class="sd">    Exmaple::</span>

<span class="sd">        result = apply_pvalue_twostage_fdrcorrection(pvalues, alpha=0.05, method=&#39;bh&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rejected</span><span class="p">,</span> <span class="n">padj</span><span class="p">,</span> <span class="n">num_hyp</span><span class="p">,</span> <span class="n">alpha_stages</span> <span class="o">=</span> <span class="n">multitest</span><span class="o">.</span><span class="n">fdrcorrection_twostage</span><span class="p">(</span><span class="n">pvalues</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">rejected</span><span class="p">,</span> <span class="n">padj</span><span class="p">)</span></div>

<div class="viewcode-block" id="apply_pvalue_permutation_fdrcorrection"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.apply_pvalue_permutation_fdrcorrection">[docs]</a><span class="k">def</span> <span class="nf">apply_pvalue_permutation_fdrcorrection</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">observed_pvalues</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">permutations</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function applies multiple hypothesis testing correction using a permutation-based false discovery rate approach.</span>

<span class="sd">    :param df: pandas dataframe with samples as rows and features as columns.</span>
<span class="sd">    :param oberved_pvalues: pandas Series with p-values calculated on the originally measured data.</span>
<span class="sd">    :param str group: name of the column containing group identifiers.</span>
<span class="sd">    :param float alpha: error rate. Values velow alpha are considered significant.</span>
<span class="sd">    :param int permutations: number of permutations to be applied.</span>
<span class="sd">    :return: Pandas dataframe with adjusted p-values and rejected columns.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = apply_pvalue_permutation_fdrcorrection(df, observed_pvalues, group=&#39;group&#39;, alpha=0.05, permutations=50)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#initial_seed = 176782</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">permutations</span>
    <span class="n">df_index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="c1">#df_columns = df.columns.values</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_index</span><span class="p">)]</span>
    <span class="c1">#columns = [&#39;identifier&#39;]</span>
    <span class="n">rand_pvalues</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">df_index</span> <span class="o">=</span> <span class="n">shuffle</span><span class="p">(</span><span class="n">df_index</span><span class="p">)</span>
        <span class="c1">#df_columns = shuffle(df_columns)</span>
        <span class="n">df_random</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_random</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_index</span>
        <span class="n">df_random</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">group</span>
        <span class="c1">#df_random.columns = df_columns</span>
        <span class="c1">#columns = [&#39;identifier&#39;, &#39;F-statistics&#39;, &#39;pvalue_&#39;+str(i)]</span>
        <span class="k">if</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df_random</span><span class="o">.</span><span class="n">index</span><span class="p">))</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df_random</span><span class="o">.</span><span class="n">index</span><span class="p">)))</span>
            <span class="c1">#aov_results = []</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_random</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="n">df_random</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                <span class="c1">#aov_results.append((col,)+calculate_anova(rows, group=group))</span>
                <span class="n">rand_pvalues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calculate_anova</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1">#rand_scores = pd.DataFrame(aov_results, columns=columns)</span>
            <span class="c1">#rand_scores = rand_scores.set_index(&quot;identifier&quot;)</span>
            <span class="c1">#rand_scores = rand_scores.dropna(how=&quot;all&quot;)</span>
            <span class="c1">#rand_scores = rand_scores[[&#39;pvalue_&#39;+str(i)]]</span>
            <span class="c1">#rand_pvalues.append(rand_scores)</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="c1">#rand_pvalues = pd.concat(rand_pvalues, axis=1)</span>
    <span class="n">rand_pvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rand_pvalues</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">observed_pvalues</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">get_counts_permutation_fdr</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">rand_pvalues</span><span class="p">,</span> <span class="n">observed_pvalues</span><span class="p">,</span> <span class="n">permutations</span><span class="p">,</span> <span class="n">alpha</span><span class="p">))</span>
    <span class="n">count</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;padj&#39;</span><span class="p">,</span> <span class="s1">&#39;rejected&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">count</span></div>

<div class="viewcode-block" id="get_counts_permutation_fdr"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.get_counts_permutation_fdr">[docs]</a><span class="k">def</span> <span class="nf">get_counts_permutation_fdr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">random</span><span class="p">,</span> <span class="n">observed</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates local FDR values (q-values) by computing the fraction of accepted hits from the permuted data over accepted hits from the measured data normalized by the total number of permutations.</span>

<span class="sd">    :param float value: computed p-value on measured data for a feature.</span>
<span class="sd">    :param ndarray random: p-values computed on the permuted data.</span>
<span class="sd">    :param observed: pandas Series with p-values calculated on the originally measured data.</span>
<span class="sd">    :param int n: number of permutations to be applied.</span>
<span class="sd">    :param float alpha: error rate. Values velow alpha are considered significant.</span>
<span class="sd">    :return: Tuple with q-value and boolean for H0 rejected.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = get_counts_permutation_fdr(value, random, observed, n=250, alpha=0.05)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">random</span><span class="p">[</span><span class="n">random</span> <span class="o">&lt;=</span> <span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="c1">#Offset in case of a = 0.0</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">observed</span> <span class="o">&lt;=</span> <span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">qvalue</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">/</span><span class="n">b</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">qvalue</span><span class="p">,</span> <span class="n">qvalue</span> <span class="o">&lt;=</span> <span class="n">alpha</span><span class="p">)</span></div>

<div class="viewcode-block" id="convertToEdgeList"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.convertToEdgeList">[docs]</a><span class="k">def</span> <span class="nf">convertToEdgeList</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function converts a pandas dataframe to an edge list where index becomes the source nodes and columns the target nodes.</span>

<span class="sd">    :param data: pandas dataframe.</span>
<span class="sd">    :param list cols: names for dataframe columns.</span>
<span class="sd">    :return: Pandas dataframe with columns cols.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">edge_list</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">edge_list</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">cols</span>

    <span class="k">return</span> <span class="n">edge_list</span></div>

<div class="viewcode-block" id="run_correlation"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_correlation">[docs]</a><span class="k">def</span> <span class="nf">run_correlation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;fdr&#39;</span><span class="p">,</span> <span class="s1">&#39;indep&#39;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function calculates pairwise correlations for columns in dataframe, and returns it in the shape of a edge list with &#39;weight&#39; as correlation score, and the ajusted p-values.</span>

<span class="sd">    :param df: pandas dataframe with samples as rows and features as columns.</span>
<span class="sd">    :param str subject: name of column containing subject identifiers.</span>
<span class="sd">    :param str group: name of column containing group identifiers.</span>
<span class="sd">    :param str method: method to use for correlation calculation (&#39;pearson&#39;, &#39;spearman&#39;).</span>
<span class="sd">    :param floar alpha: error rate. Values velow alpha are considered significant.</span>
<span class="sd">    :param tuple correction: first string corresponds to FDR correction type (&#39;fdr&#39;, &#39;2fdr&#39;), and second string determines which method to use (fdr:&#39;indep&#39;, &#39;negcorr&#39;, 2fdr:&#39;bky&#39;, &#39;bh&#39;).</span>
<span class="sd">    :return: Pandas dataframe with columns: &#39;node1&#39;, &#39;node2&#39;, &#39;weight&#39;, &#39;padj&#39; and &#39;rejected&#39;.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = run_correlation(df, alpha=0.05, subject=&#39;subject&#39;, group=&#39;group&#39;, method=&#39;pearson&#39;, correction=(&#39;fdr&#39;, &#39;indep&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">correlation</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">check_is_paired</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">subject</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">correlation</span> <span class="o">=</span> <span class="n">run_rm_correlation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="n">correction</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">_get_numeric_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">run_efficient_correlation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
            <span class="n">rdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">correlation</span> <span class="o">=</span> <span class="n">convertToEdgeList</span><span class="p">(</span><span class="n">rdf</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;node1&quot;</span><span class="p">,</span> <span class="s2">&quot;node2&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">])</span>
            <span class="n">pvalues</span> <span class="o">=</span> <span class="n">convertToEdgeList</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;node1&quot;</span><span class="p">,</span> <span class="s2">&quot;node2&quot;</span><span class="p">,</span> <span class="s2">&quot;pvalue&quot;</span><span class="p">])</span>
            <span class="n">correlation</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">correlation</span><span class="p">,</span><span class="n">pvalues</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;node1&#39;</span><span class="p">,</span><span class="s1">&#39;node2&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">correction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fdr&#39;</span><span class="p">:</span>
                <span class="n">rejected</span><span class="p">,</span> <span class="n">padj</span> <span class="o">=</span> <span class="n">apply_pvalue_fdrcorrection</span><span class="p">(</span><span class="n">correlation</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">correction</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">correction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2fdr&#39;</span><span class="p">:</span>
                <span class="n">rejected</span><span class="p">,</span> <span class="n">padj</span> <span class="o">=</span> <span class="n">apply_pvalue_twostage_fdrcorrection</span><span class="p">(</span><span class="n">correlation</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">correction</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">correlation</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">correlation</span><span class="p">[</span><span class="s1">&#39;pvalue&#39;</span><span class="p">]]</span> <span class="c1">#limit number of decimals to 8 and avoid scientific notation</span>
            <span class="n">correlation</span><span class="p">[</span><span class="s2">&quot;padj&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">padj</span><span class="p">]</span> <span class="c1">#limit number of decimals to 8 and avoid scientific notation</span>
            <span class="n">correlation</span><span class="p">[</span><span class="s2">&quot;rejected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rejected</span>
            <span class="n">correlation</span> <span class="o">=</span> <span class="n">correlation</span><span class="p">[</span><span class="n">correlation</span><span class="o">.</span><span class="n">rejected</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">correlation</span></div>

<div class="viewcode-block" id="run_multi_correlation"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_multi_correlation">[docs]</a><span class="k">def</span> <span class="nf">run_multi_correlation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;biological_sample&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;fdr&#39;</span><span class="p">,</span> <span class="s1">&#39;indep&#39;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function merges all input dataframes and calculates pairwise correlations for all columns.</span>

<span class="sd">    :param dict df: dictionary of pandas dataframes with samples as rows and features as columns.</span>
<span class="sd">    :param str subject: name of the column containing subject identifiers.</span>
<span class="sd">    :param str group: name of the column containing group identifiers.</span>
<span class="sd">    :param list on: column names to join dataframes on (must be found in all dataframes).</span>
<span class="sd">    :param str method: method to use for correlation calculation (&#39;pearson&#39;, &#39;spearman&#39;).</span>
<span class="sd">    :param float alpha: error rate. Values velow alpha are considered significant.</span>
<span class="sd">    :param tuple correction: first string corresponds to FDR correction type (&#39;fdr&#39;, &#39;2fdr&#39;), and second string determines which method to use (fdr:&#39;indep&#39;, &#39;negcorr&#39;, 2fdr:&#39;bky&#39;, &#39;bh&#39;).</span>
<span class="sd">    :return: Pandas dataframe with columns: &#39;node1&#39;, &#39;node2&#39;, &#39;weight&#39;, &#39;padj&#39; and &#39;rejected&#39;.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = run_multi_correlation(df, alpha=0.05, subject=&#39;subject&#39;, on=[&#39;subject&#39;, &#39;biological_sample&#39;] , group=&#39;group&#39;, method=&#39;pearson&#39;, correction=(&#39;fdr&#39;, &#39;indep&#39;))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">multidf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">correlation</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">multidf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">multidf</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">multidf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">multidf</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">dtype</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">on</span><span class="p">)</span>

        <span class="n">correlation</span> <span class="o">=</span> <span class="n">run_correlation</span><span class="p">(</span><span class="n">multidf</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="n">correction</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">correlation</span></div>

<div class="viewcode-block" id="calculate_rm_correlation"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.calculate_rm_correlation">[docs]</a><span class="k">def</span> <span class="nf">calculate_rm_correlation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">subject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes correlation and p-values between two columns a and b in df.</span>

<span class="sd">    :param df: pandas dataframe with subjects as rows and two features and columns.</span>
<span class="sd">    :param str x: feature a name.</span>
<span class="sd">    :param str y: feature b name.</span>
<span class="sd">    :param subject: column name containing the covariate variable.</span>
<span class="sd">    :return: Tuple with values for: feature a, feature b, correlation, p-value and degrees of freedom.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = calculate_rm_correlation(df, x=&#39;feature a&#39;, y=&#39;feature b&#39;, subject=&#39;subject&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ANCOVA model</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;col0&quot;</span><span class="p">,</span><span class="s2">&quot;col1&quot;</span><span class="p">,</span> <span class="n">subject</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;col0&quot;</span>
    <span class="n">b</span> <span class="o">=</span> <span class="s2">&quot;col1&quot;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">cols</span>

    <span class="n">formula</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="s1">&#39; ~ &#39;</span> <span class="o">+</span> <span class="s1">&#39;C(&#39;</span> <span class="o">+</span> <span class="n">subject</span> <span class="o">+</span> <span class="s1">&#39;) + &#39;</span> <span class="o">+</span> <span class="n">a</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">anova_lm</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="c1"># Extract the sign of the correlation and dof</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
    <span class="n">dof</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Residual&#39;</span><span class="p">,</span> <span class="s1">&#39;df&#39;</span><span class="p">])</span>
    <span class="c1"># Extract correlation coefficient from sum of squares</span>
    <span class="n">ssfactor</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;sum_sq&#39;</span><span class="p">]</span>
    <span class="n">sserror</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;Residual&#39;</span><span class="p">,</span> <span class="s1">&#39;sum_sq&#39;</span><span class="p">]</span>
    <span class="n">rm</span> <span class="o">=</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ssfactor</span> <span class="o">/</span> <span class="p">(</span><span class="n">ssfactor</span> <span class="o">+</span> <span class="n">sserror</span><span class="p">))</span>
    <span class="c1"># Extract p-value</span>
    <span class="n">pvalue</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;PR(&gt;F)&#39;</span><span class="p">]</span>
    <span class="n">pvalue</span> <span class="o">*=</span> <span class="mf">0.5</span>

    <span class="c1">#r, dof, pvalue, ci, power = pg.rm_corr(data=df, x=x, y=y, subject=subject)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">,</span> <span class="n">dof</span><span class="p">)</span></div>

<div class="viewcode-block" id="run_rm_correlation"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_rm_correlation">[docs]</a><span class="k">def</span> <span class="nf">run_rm_correlation</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;fdr&#39;</span><span class="p">,</span> <span class="s1">&#39;indep&#39;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes pairwise repeated measurements correlations for all columns in dataframe, and returns results as an edge list with &#39;weight&#39; as correlation score, p-values, degrees of freedom and ajusted p-values.</span>

<span class="sd">    :param df: pandas dataframe with samples as rows and features as columns.</span>
<span class="sd">    :param str subject: name of column containing subject identifiers.</span>
<span class="sd">    :param float alpha: error rate. Values velow alpha are considered significant.</span>
<span class="sd">    :param tuple correction: first string corresponds to FDR correction type (&#39;fdr&#39;, &#39;2fdr&#39;), and second string determines which method to use (fdr:&#39;indep&#39;, &#39;negcorr&#39;, 2fdr:&#39;bky&#39;, &#39;bh&#39;).</span>
<span class="sd">    :return: Pandas dataframe with columns: &#39;node1&#39;, &#39;node2&#39;, &#39;weight&#39;, &#39;pvalue&#39;, &#39;dof&#39;, &#39;padj&#39; and &#39;rejected&#39;.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = run_rm_correlation(df, alpha=0.05, subject=&#39;subject&#39;, correction=(&#39;fdr&#39;, &#39;indep&#39;))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span><span class="o">.</span><span class="n">_get_numeric_data</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">combinations</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">:</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">subject</span><span class="p">]]</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">calculate_rm_correlation</span><span class="p">(</span><span class="n">subset</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">subject</span><span class="p">)</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">correlation</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;node1&quot;</span><span class="p">,</span> <span class="s2">&quot;node2&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">,</span> <span class="s2">&quot;pvalue&quot;</span><span class="p">,</span> <span class="s2">&quot;dof&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">correction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fdr&#39;</span><span class="p">:</span>
            <span class="n">rejected</span><span class="p">,</span> <span class="n">padj</span> <span class="o">=</span> <span class="n">apply_pvalue_fdrcorrection</span><span class="p">(</span><span class="n">correlation</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">correction</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">correction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2fdr&#39;</span><span class="p">:</span>
            <span class="n">rejected</span><span class="p">,</span> <span class="n">padj</span> <span class="o">=</span> <span class="n">apply_pvalue_twostage_fdrcorrection</span><span class="p">(</span><span class="n">correlation</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">correction</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">correlation</span><span class="p">[</span><span class="s2">&quot;padj&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">padj</span><span class="p">]</span> <span class="c1">#limit number of decimals to 8 and avoid scientific notation</span>
        <span class="n">correlation</span><span class="p">[</span><span class="s2">&quot;rejected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rejected</span>
        <span class="n">correlation</span> <span class="o">=</span> <span class="n">correlation</span><span class="p">[</span><span class="n">correlation</span><span class="o">.</span><span class="n">rejected</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">correlation</span></div>

<div class="viewcode-block" id="run_efficient_correlation"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_efficient_correlation">[docs]</a><span class="k">def</span> <span class="nf">run_efficient_correlation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates pairwise correlations and returns lower triangle of the matrix with correlation values and p-values.</span>

<span class="sd">    :param data: pandas dataframe with samples as index and features as columns (numeric data only).</span>
<span class="sd">    :param str method: method to use for correlation calculation (&#39;pearson&#39;, &#39;spearman&#39;).</span>
<span class="sd">    :return: Two numpy arrays: correlation and p-values.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = run_efficient_correlation(data, method=&#39;pearson&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;pearson&#39;</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;spearman&#39;</span><span class="p">:</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">spearmanr</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">diagonal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rf</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">diagonal</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">rf</span> <span class="o">*</span> <span class="n">rf</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rf</span> <span class="o">*</span> <span class="n">rf</span><span class="p">))</span>
    <span class="n">pf</span> <span class="o">=</span> <span class="n">betainc</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">df</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">df</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span> <span class="o">+</span> <span class="n">ts</span><span class="p">))</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pf</span>
    <span class="n">p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pf</span>
    <span class="n">p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">diag_indices</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">r</span><span class="p">[</span><span class="n">diagonal</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">p</span><span class="p">[</span><span class="n">diagonal</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">p</span></div>

<div class="viewcode-block" id="calculate_paired_ttest"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.calculate_paired_ttest">[docs]</a><span class="k">def</span> <span class="nf">calculate_paired_ttest</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">condition1</span><span class="p">,</span> <span class="n">condition2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the t-test on RELATED samples belonging to two different groups. For more information visit https://docs.scipy.org/doc/scipy-0.14.0/reference/generated/scipy.stats.ttest_rel.html.</span>

<span class="sd">    :param df: pandas dataframe with groups and subjects as rows and protein identifier as column.</span>
<span class="sd">    :param str condition1: identifier of first group.</span>
<span class="sd">    :param str condition2: identifier of second group.</span>
<span class="sd">    :return: Tuple with t-statistics, two-tailed p-value, mean of first group, mean of second group and logfc.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = calculate_paired_ttest(df, &#39;group1&#39;, &#39;group2&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">group1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">condition1</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">group2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">condition2</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">mean1</span> <span class="o">=</span> <span class="n">group1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">mean2</span> <span class="o">=</span> <span class="n">group2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">log2fc</span> <span class="o">=</span> <span class="n">mean1</span> <span class="o">-</span> <span class="n">mean2</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">pvalue</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_rel</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">,</span> <span class="n">mean1</span><span class="p">,</span> <span class="n">mean2</span><span class="p">,</span> <span class="n">log2fc</span><span class="p">)</span></div>

<div class="viewcode-block" id="calculate_ttest_samr"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.calculate_ttest_samr">[docs]</a><span class="k">def</span> <span class="nf">calculate_ttest_samr</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">s0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">paired</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates modified T-test using &#39;samr&#39; R package.</span>

<span class="sd">    :param df: pandas dataframe with group as columns and protein identifier as rows</span>
<span class="sd">    :param list abels: integers reflecting the group each sample belongs to (e.g. group1 = 1, group2 = 2)</span>
<span class="sd">    :param int n: number of samples</span>
<span class="sd">    :param float s0: exchangeability factor for denominator of test statistic</span>
<span class="sd">    :param bool paired: True if samples are paired</span>
<span class="sd">    :return: Pandas dataframe with columns &#39;identifier&#39;, &#39;group1&#39;, &#39;group2&#39;, &#39;mean(group1)&#39;, &#39;mean(group1)&#39;, &#39;log2FC&#39;, &#39;FC&#39;, &#39;t-statistics&#39;, &#39;p-value&#39;.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = calculate_ttest_samr(df, labels, n=2, s0=0.1, paired=False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">r_installation</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No valid installation of R&quot;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;group1&#39;</span><span class="p">,</span> <span class="s1">&#39;group2&#39;</span><span class="p">,</span> <span class="s1">&#39;mean(group1)&#39;</span><span class="p">,</span> <span class="s1">&#39;mean(group2)&#39;</span><span class="p">,</span> <span class="s1">&#39;log2FC&#39;</span><span class="p">,</span> <span class="s1">&#39;FC&#39;</span><span class="p">,</span> <span class="s1">&#39;t-statistics&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue&#39;</span><span class="p">])</span>
    <span class="n">conditions</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">mean1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">conditions</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mean2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">conditions</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">paired</span><span class="p">:</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">cur_count</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">cur_count</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="n">conditions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="p">(</span><span class="n">cur_count</span><span class="o">+</span><span class="mi">1</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_count</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">ttest_res</span> <span class="o">=</span> <span class="n">samr</span><span class="o">.</span><span class="n">paired_ttest_func</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">unlist</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">s0</span><span class="o">=</span><span class="n">s0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ttest_res</span> <span class="o">=</span> <span class="n">samr</span><span class="o">.</span><span class="n">ttest_func</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">unlist</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">s0</span><span class="o">=</span><span class="n">s0</span><span class="p">)</span>

    <span class="n">pvalues</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">stats_r</span><span class="o">.</span><span class="n">pt</span><span class="p">(</span><span class="o">-</span><span class="n">base</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ttest_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mean1</span><span class="p">,</span> <span class="n">mean2</span><span class="p">,</span> <span class="n">ttest_res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ttest_res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pvalues</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;mean(group1)&#39;</span><span class="p">,</span> <span class="s1">&#39;mean(group2)&#39;</span><span class="p">,</span> <span class="s1">&#39;log2FC&#39;</span><span class="p">,</span> <span class="s1">&#39;t-statistics&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue&#39;</span><span class="p">]</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;group1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conditions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;group2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conditions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;FC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;log2FC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[[</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;group1&#39;</span><span class="p">,</span> <span class="s1">&#39;group2&#39;</span><span class="p">,</span> <span class="s1">&#39;mean(group1)&#39;</span><span class="p">,</span> <span class="s1">&#39;mean(group2)&#39;</span><span class="p">,</span> <span class="s1">&#39;log2FC&#39;</span><span class="p">,</span> <span class="s1">&#39;FC&#39;</span><span class="p">,</span> <span class="s1">&#39;t-statistics&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue&#39;</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="calculate_ttest"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.calculate_ttest">[docs]</a><span class="k">def</span> <span class="nf">calculate_ttest</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">condition1</span><span class="p">,</span> <span class="n">condition2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the t-test for the means of independent samples belonging to two different groups. For more information visit https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.ttest_ind.html.</span>

<span class="sd">    :param df: pandas dataframe with groups and subjects as rows and protein identifier as column.</span>
<span class="sd">    :param str condition1: identifier of first group.</span>
<span class="sd">    :param str condition2: ientifier of second group.</span>
<span class="sd">    :return: Tuple with t-statistics, two-tailed p-value, mean of first group, mean of second group and logfc.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = calculate_ttest(df, &#39;group1&#39;, &#39;group2&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">group1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">condition1</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">group2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">condition2</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">mean1</span> <span class="o">=</span> <span class="n">group1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">mean2</span> <span class="o">=</span> <span class="n">group2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">log2fc</span> <span class="o">=</span> <span class="n">mean1</span> <span class="o">-</span> <span class="n">mean2</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">pvalue</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">,</span> <span class="n">mean1</span><span class="p">,</span> <span class="n">mean2</span><span class="p">,</span> <span class="n">log2fc</span><span class="p">)</span></div>

<div class="viewcode-block" id="calculate_THSD"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.calculate_THSD">[docs]</a><span class="k">def</span> <span class="nf">calculate_THSD</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pairwise Tukey-HSD posthoc test using pingouin stats. For more information visit https://pingouin-stats.org/generated/pingouin.pairwise_tukey.html</span>

<span class="sd">    :param df: pandas dataframe with group as rows and protein identifier as column</span>
<span class="sd">    :param str group: column label containing the within factor</span>
<span class="sd">    :param float alpha: significance level</span>
<span class="sd">    :return: Pandas dataframe.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = calculate_THSD(df, group=&#39;group&#39;, alpha=0.05)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_results</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">name</span>
        <span class="n">df_results</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">pairwise_tukey</span><span class="p">(</span><span class="n">dv</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">between</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">tail</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">)</span>
        <span class="n">df_results</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;group1&#39;</span><span class="p">,</span> <span class="s1">&#39;group2&#39;</span><span class="p">,</span> <span class="s1">&#39;mean(group1)&#39;</span><span class="p">,</span> <span class="s1">&#39;mean(group2)&#39;</span><span class="p">,</span> <span class="s1">&#39;log2FC&#39;</span><span class="p">,</span> <span class="s1">&#39;std_error&#39;</span><span class="p">,</span> <span class="s1">&#39;tail&#39;</span><span class="p">,</span> <span class="s1">&#39;t-statistics&#39;</span><span class="p">,</span> <span class="s1">&#39;padj_THSD&#39;</span><span class="p">,</span> <span class="s1">&#39;effsize&#39;</span><span class="p">]</span>
        <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;efftype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;hedges&#39;</span>
        <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
        <span class="n">df_results</span> <span class="o">=</span> <span class="n">df_results</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;identifier&#39;</span><span class="p">)</span>
        <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;FC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;log2FC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;rejected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;padj_THSD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">alpha</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_results</span></div>

<div class="viewcode-block" id="calculate_pairwise_ttest"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.calculate_pairwise_ttest">[docs]</a><span class="k">def</span> <span class="nf">calculate_pairwise_ttest</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs pairwise t-test using pingouin, as a posthoc test, and calculates fold-changes. For more information visit https://pingouin-stats.org/generated/pingouin.pairwise_ttests.html.</span>

<span class="sd">    :param df: pandas dataframe with subject and group as rows and protein identifier as column.</span>
<span class="sd">    :param str column: column label containing the dependant variable</span>
<span class="sd">    :param str subject: column label containing subject identifiers</span>
<span class="sd">    :param str group: column label containing the between factor</span>
<span class="sd">    :param str correction: method used for testing and adjustment of p-values.</span>
<span class="sd">    :return: Pandas dataframe with means, standard deviations, test-statistics, degrees of freedom and effect size columns.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = calculate_pairwise_ttest(df, &#39;protein a&#39;, subject=&#39;subject&#39;, group=&#39;group&#39;, correction=&#39;none&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">posthoc_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Contrast&#39;</span><span class="p">,</span> <span class="s1">&#39;group1&#39;</span><span class="p">,</span> <span class="s1">&#39;group2&#39;</span><span class="p">,</span> <span class="s1">&#39;mean(group1)&#39;</span><span class="p">,</span> <span class="s1">&#39;std(group1)&#39;</span><span class="p">,</span> <span class="s1">&#39;mean(group2)&#39;</span><span class="p">,</span> <span class="s1">&#39;std(group2)&#39;</span><span class="p">,</span> <span class="s1">&#39;Paired&#39;</span><span class="p">,</span> <span class="s1">&#39;Parametric&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;dof&#39;</span><span class="p">,</span> <span class="s1">&#39;tail&#39;</span><span class="p">,</span> <span class="s1">&#39;padj&#39;</span><span class="p">,</span> <span class="s1">&#39;BF10&#39;</span><span class="p">,</span> <span class="s1">&#39;effsize&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">correction</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="n">valid_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;group1&#39;</span><span class="p">,</span> <span class="s1">&#39;group2&#39;</span><span class="p">,</span> <span class="s1">&#39;mean(group1)&#39;</span><span class="p">,</span> <span class="s1">&#39;std(group1)&#39;</span><span class="p">,</span> <span class="s1">&#39;mean(group2)&#39;</span><span class="p">,</span> <span class="s1">&#39;std(group2)&#39;</span><span class="p">,</span> <span class="s1">&#39;Paired&#39;</span><span class="p">,</span><span class="s1">&#39;Parametric&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;dof&#39;</span><span class="p">,</span> <span class="s1">&#39;BF10&#39;</span><span class="p">,</span> <span class="s1">&#39;effsize&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">valid_cols</span> <span class="o">=</span> <span class="n">posthoc_columns</span>
    <span class="n">posthoc</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">pairwise_ttests</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">dv</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">between</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">effsize</span><span class="o">=</span><span class="s1">&#39;hedges&#39;</span><span class="p">,</span> <span class="n">return_desc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padjust</span><span class="o">=</span><span class="n">correction</span><span class="p">)</span>
    <span class="n">posthoc</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span>  <span class="n">posthoc_columns</span>
    <span class="n">posthoc</span> <span class="o">=</span> <span class="n">posthoc</span><span class="p">[</span><span class="n">valid_cols</span><span class="p">]</span>
    <span class="n">posthoc</span> <span class="o">=</span> <span class="n">complement_posthoc</span><span class="p">(</span><span class="n">posthoc</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
    <span class="n">posthoc</span> <span class="o">=</span> <span class="n">posthoc</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;identifier&#39;</span><span class="p">)</span>
    <span class="n">posthoc</span><span class="p">[</span><span class="s1">&#39;efftype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;hedges&#39;</span>

    <span class="k">return</span> <span class="n">posthoc</span></div>

<div class="viewcode-block" id="complement_posthoc"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.complement_posthoc">[docs]</a><span class="k">def</span> <span class="nf">complement_posthoc</span><span class="p">(</span><span class="n">posthoc</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates fold-changes after posthoc test.</span>

<span class="sd">    :param posthoc: pandas dataframe from posthoc test. Should have at least columns &#39;mean(group1)&#39; and &#39;mean(group2)&#39;.</span>
<span class="sd">    :param str identifier: feature identifier.</span>
<span class="sd">    :return: Pandas dataframe with additional columns &#39;identifier&#39;, &#39;log2FC&#39; and &#39;FC&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">posthoc</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">identifier</span>
    <span class="n">posthoc</span><span class="p">[</span><span class="s1">&#39;log2FC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posthoc</span><span class="p">[</span><span class="s1">&#39;mean(group1)&#39;</span><span class="p">]</span> <span class="o">-</span><span class="n">posthoc</span><span class="p">[</span><span class="s1">&#39;mean(group2)&#39;</span><span class="p">]</span>
    <span class="n">posthoc</span><span class="p">[</span><span class="s1">&#39;FC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posthoc</span><span class="p">[</span><span class="s1">&#39;log2FC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">posthoc</span></div>

<div class="viewcode-block" id="calculate_dabest"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.calculate_dabest">[docs]</a><span class="k">def</span> <span class="nf">calculate_dabest</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">paired</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">id_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="s1">&#39;mean_diff&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>


<span class="sd">    :param df:</span>
<span class="sd">    :param idx:</span>
<span class="sd">    :param x:</span>
<span class="sd">    :param y:</span>
<span class="sd">    :param paired:</span>
<span class="sd">    :param id_col:</span>
<span class="sd">    :param test:</span>
<span class="sd">    :return:</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;group1&quot;</span><span class="p">,</span> <span class="s2">&quot;group2&quot;</span><span class="p">,</span> <span class="s2">&quot;effect size&quot;</span><span class="p">,</span> <span class="s2">&quot;paired&quot;</span><span class="p">,</span> <span class="s1">&#39;difference&#39;</span><span class="p">,</span> <span class="s2">&quot;CI&quot;</span><span class="p">,</span> <span class="s2">&quot;bca low&quot;</span><span class="p">,</span> <span class="s2">&quot;bca high&quot;</span><span class="p">,</span> <span class="s2">&quot;bca interval idx&quot;</span><span class="p">,</span> <span class="s2">&quot;pct low&quot;</span><span class="p">,</span> <span class="s2">&quot;pct high&quot;</span><span class="p">,</span> <span class="s2">&quot;pct interval idx&quot;</span><span class="p">,</span> <span class="s2">&quot;bootstraps&quot;</span><span class="p">,</span> <span class="s1">&#39;resamples&#39;</span><span class="p">,</span> <span class="s1">&#39;random seed&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue Welch&#39;</span><span class="p">,</span> <span class="s1">&#39;statistic Welch&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue Student T&#39;</span><span class="p">,</span> <span class="s1">&#39;statistic Student T&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue Mann Whitney&#39;</span><span class="p">,</span> <span class="s1">&#39;statistic Mann Whitney&#39;</span><span class="p">]</span>
    <span class="n">valid_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;group1&quot;</span><span class="p">,</span> <span class="s2">&quot;group2&quot;</span><span class="p">,</span> <span class="s2">&quot;effect size&quot;</span><span class="p">,</span> <span class="s2">&quot;paired&quot;</span><span class="p">,</span> <span class="s1">&#39;difference&#39;</span><span class="p">,</span> <span class="s2">&quot;CI&quot;</span><span class="p">,</span> <span class="s1">&#39;pvalue Welch&#39;</span><span class="p">,</span> <span class="s1">&#39;statistic Welch&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue Student T&#39;</span><span class="p">,</span> <span class="s1">&#39;statistic Student T&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue Mann Whitney&#39;</span><span class="p">,</span> <span class="s1">&#39;statistic Mann Whitney&#39;</span><span class="p">]</span>
    <span class="n">dabest_df</span> <span class="o">=</span> <span class="n">dabest</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">paired</span><span class="o">=</span><span class="n">paired</span><span class="p">,</span> <span class="n">id_col</span><span class="o">=</span><span class="n">id_col</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">test</span> <span class="o">==</span> <span class="s1">&#39;mean_diff&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">dabest_df</span><span class="o">.</span><span class="n">mean_diff</span><span class="o">.</span><span class="n">results</span>
    <span class="k">elif</span> <span class="n">test</span> <span class="o">==</span> <span class="s1">&#39;median_diff&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">dabest_df</span><span class="o">.</span><span class="n">median_diff</span><span class="o">.</span><span class="n">results</span>
    <span class="k">elif</span> <span class="n">test</span> <span class="o">==</span> <span class="s1">&#39;cohens_d&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">dabest_df</span><span class="o">.</span><span class="n">cohens_d</span><span class="o">.</span><span class="n">results</span>
    <span class="k">elif</span> <span class="n">test</span> <span class="o">==</span> <span class="s1">&#39;hedges_g&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">dabest_df</span><span class="o">.</span><span class="n">hedges_g</span><span class="o">.</span><span class="n">results</span>
    <span class="k">elif</span> <span class="n">test</span> <span class="o">==</span> <span class="s1">&#39;cliffs_delta&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">dabest_df</span><span class="o">.</span><span class="n">cliffs_delta</span>

    <span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">cols</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">valid_cols</span><span class="p">]</span>

    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>

    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="calculate_anova_samr"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.calculate_anova_samr">[docs]</a><span class="k">def</span> <span class="nf">calculate_anova_samr</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">s0</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates modified one-way ANOVA using &#39;samr&#39; R package.</span>

<span class="sd">    :param df: pandas dataframe with group as columns and protein identifier as rows</span>
<span class="sd">    :param list labels: integers reflecting the group each sample belongs to (e.g. group1 = 1, group2 = 2, group3 = 3)</span>
<span class="sd">    :param float s0: exchangeability factor for denominator of test statistic</span>
<span class="sd">    :return: Pandas dataframe with protein identifiers and F-statistics.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = calculate_anova_samr(df, labels, s0=0.1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">r_installation</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No valid installation of R&quot;</span><span class="p">)</span>

    <span class="n">aov_res</span> <span class="o">=</span> <span class="n">wgcna</span><span class="o">.</span><span class="n">multiclass_func</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">unlist</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">s0</span><span class="o">=</span><span class="n">s0</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">aov_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;F-statistics&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="calculate_anova"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.calculate_anova">[docs]</a><span class="k">def</span> <span class="nf">calculate_anova</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates one-way ANOVA using scipy stats.</span>

<span class="sd">    :param df: pandas dataframe with group as rows and protein identifier as column</span>
<span class="sd">    :param str group: column with group identifiers</span>
<span class="sd">    :return: Tuple with t-statistics and p-value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">group_values</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">pvalue</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">f_oneway</span><span class="p">(</span><span class="o">*</span><span class="n">group_values</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">)</span></div>

<div class="viewcode-block" id="calculate_repeated_measures_anova"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.calculate_repeated_measures_anova">[docs]</a><span class="k">def</span> <span class="nf">calculate_repeated_measures_anova</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    One-way and two-way repeated measures ANOVA using pingouin stats.</span>

<span class="sd">    :param df: pandas dataframe with samples as rows and protein identifier as column. Data must be in long-format for two-way repeated measures.</span>
<span class="sd">    :param str column: column label containing the dependant variable</span>
<span class="sd">    :param str subject: column label containing subject identifiers</span>
<span class="sd">    :param str group: column label containing the within factor</span>
<span class="sd">    :return: Tuple with protein identifier, t-statistics and p-value.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = calculate_repeated_measures_anova(df, &#39;protein a&#39;, subject=&#39;subject&#39;, group=&#39;group&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aov_result</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">rm_anova</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">dv</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">within</span><span class="o">=</span><span class="n">group</span><span class="p">,</span><span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">detailed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">aov_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Source&#39;</span><span class="p">,</span> <span class="s1">&#39;SS&#39;</span><span class="p">,</span> <span class="s1">&#39;DF&#39;</span><span class="p">,</span> <span class="s1">&#39;MS&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue&#39;</span><span class="p">,</span> <span class="s1">&#39;padj&#39;</span><span class="p">,</span> <span class="s1">&#39;np2&#39;</span><span class="p">,</span> <span class="s1">&#39;eps&#39;</span><span class="p">,</span> <span class="s1">&#39;sphericity&#39;</span><span class="p">,</span> <span class="s1">&#39;Mauchlys sphericity&#39;</span><span class="p">,</span> <span class="s1">&#39;p-spher&#39;</span><span class="p">]</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">pvalue</span> <span class="o">=</span> <span class="n">aov_result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_max_permutations"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.get_max_permutations">[docs]</a><span class="k">def</span> <span class="nf">get_max_permutations</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get maximum number of permutations according to number of samples.</span>

<span class="sd">    :param df: pandas dataframe with samples as rows and protein identifiers as columns</span>
<span class="sd">    :param str group: column with group identifiers</span>
<span class="sd">    :return: Maximum number of permutations.</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
    <span class="n">num_per_group</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">max_perm</span> <span class="o">=</span> <span class="n">factorial</span><span class="p">(</span><span class="n">num_groups</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">num_per_group</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">max_perm</span></div>

<div class="viewcode-block" id="check_is_paired"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.check_is_paired">[docs]</a><span class="k">def</span> <span class="nf">check_is_paired</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if samples are paired.</span>

<span class="sd">    :param df: pandas dataframe with samples as rows and protein identifiers as columns (with additional columns &#39;group&#39;, &#39;sample&#39; and &#39;subject&#39;).</span>
<span class="sd">    :param str subject: column with subject identifiers</span>
<span class="sd">    :param str group: column with group identifiers</span>
<span class="sd">    :return: True if paired samples.</span>
<span class="sd">    :rtype: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_pair</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">subject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">count_subject_groups</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">subject</span><span class="p">)[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">is_pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">count_subject_groups</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">is_pair</span></div>


<div class="viewcode-block" id="run_dabest"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_dabest">[docs]</a><span class="k">def</span> <span class="nf">run_dabest</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">drop_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">],</span> <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="s1">&#39;mean_diff&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>


<span class="sd">    :param df:</span>
<span class="sd">    :param list drop_cols:</span>
<span class="sd">    :param str subject:</span>
<span class="sd">    :param str group:</span>
<span class="sd">    :param str test:</span>
<span class="sd">    :return: Pandas dataframe</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">paired</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">subject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">paired</span> <span class="o">=</span> <span class="n">check_is_paired</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

    <span class="n">groups</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="n">subject</span><span class="p">,</span><span class="n">group</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">calculate_dabest</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">idx</span><span class="o">=</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">x</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">id_col</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">paired</span><span class="o">=</span><span class="n">paired</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scores</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;identifier&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">scores</span></div>

<div class="viewcode-block" id="run_anova"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_anova">[docs]</a><span class="k">def</span> <span class="nf">run_anova</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">drop_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">,</span><span class="s1">&#39;subject&#39;</span><span class="p">],</span> <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">permutations</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs statistical test for each protein in a dataset.</span>
<span class="sd">    Checks what type of data is the input (paired, unpaired or repeated measurements) and performs posthoc tests for multiclass data.</span>
<span class="sd">    Multiple hypothesis correction uses permutation-based if permutations&gt;0 and Benjamini/Hochberg if permutations=0.</span>

<span class="sd">    :param df: pandas dataframe with samples as rows and protein identifiers as columns (with additional columns &#39;group&#39;, &#39;sample&#39; and &#39;subject&#39;).</span>
<span class="sd">    :param str subject: column with subject identifiers</span>
<span class="sd">    :param str group: column with group identifiers</span>
<span class="sd">    :param list drop_cols: column labels to be dropped from the dataframe</span>
<span class="sd">    :param float alpha: error rate for multiple hypothesis correction</span>
<span class="sd">    :param int permutations: number of permutations used to estimate false discovery rates.</span>
<span class="sd">    :return: Pandas dataframe with columns &#39;identifier&#39;, &#39;group1&#39;, &#39;group2&#39;, &#39;mean(group1)&#39;, &#39;mean(group2)&#39;, &#39;Log2FC&#39;, &#39;std_error&#39;, &#39;tail&#39;, &#39;t-statistics&#39;, &#39;padj_THSD&#39;, &#39;effsize&#39;, &#39;efftype&#39;, &#39;FC&#39;, &#39;rejected&#39;, &#39;F-statistics&#39;, &#39;p-value&#39;, &#39;correction&#39;, &#39;-log10 p-value&#39;, and &#39;method&#39;.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = run_anova(df, alpha=0.05, drop_cols=[&quot;sample&quot;,&#39;subject&#39;], subject=&#39;subject&#39;, group=&#39;group&#39;, permutations=50)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">subject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">check_is_paired</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">drop_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">drop_cols</span> <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="n">subject</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">subject</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">run_ttest</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">drop_cols</span><span class="o">=</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">paired</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="s1">&#39;indep&#39;</span><span class="p">,</span> <span class="n">permutations</span><span class="o">=</span><span class="n">permutations</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">res</span> <span class="o">=</span> <span class="n">run_repeated_measurements_anova</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">drop_cols</span><span class="o">=</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">permutations</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="n">group</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">aov_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pairwise_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">aov_results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">col</span><span class="p">,)</span> <span class="o">+</span> <span class="n">calculate_anova</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">))</span>
            <span class="n">thsd_result</span> <span class="o">=</span> <span class="n">calculate_THSD</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">thsd_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pairwise_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thsd_result</span><span class="p">)</span>

        <span class="n">max_perm</span> <span class="o">=</span> <span class="n">get_max_permutations</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">format_anova_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aov_results</span><span class="p">,</span> <span class="n">pairwise_results</span><span class="p">,</span>  <span class="n">group</span><span class="p">,</span> <span class="n">permutations</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">max_perm</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;Method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;One-way anova&#39;</span>

    <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="run_repeated_measurements_anova"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_repeated_measurements_anova">[docs]</a><span class="k">def</span> <span class="nf">run_repeated_measurements_anova</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">drop_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">],</span> <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">permutations</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs repeated measurements anova and pairwise posthoc tests for each protein in dataframe.</span>

<span class="sd">    :param df: pandas dataframe with samples as rows and protein identifiers as columns (with additional columns &#39;group&#39;, &#39;sample&#39; and &#39;subject&#39;).</span>
<span class="sd">    :param str subject: column with subject identifiers</span>
<span class="sd">    :param srt group: column with group identifiers</span>
<span class="sd">    :param list drop_cols: column labels to be dropped from the dataframe</span>
<span class="sd">    :param float alpha: error rate for multiple hypothesis correction</span>
<span class="sd">    :param int permutations: number of permutations used to estimate false discovery rates</span>
<span class="sd">    :return: Pandas dataframe</span>

<span class="sd">    Example::</span>

<span class="sd">        result = run_repeated_measurements_anova(df, alpha=0.05, drop_cols=[&#39;sample&#39;], subject=&#39;subject&#39;, group=&#39;group&#39;, permutations=50)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="n">subject</span><span class="p">,</span><span class="n">group</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">aov_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pairwise_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">aov</span> <span class="o">=</span> <span class="n">calculate_repeated_measures_anova</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">column</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
        <span class="n">aov_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aov</span><span class="p">)</span>
        <span class="n">pairwise_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calculate_pairwise_ttest</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">column</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">))</span>

    <span class="n">max_perm</span> <span class="o">=</span> <span class="n">get_max_permutations</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">format_anova_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aov_results</span><span class="p">,</span> <span class="n">pairwise_results</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">permutations</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">max_perm</span><span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;Method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Repeated measurements anova&#39;</span>

    <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="format_anova_table"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.format_anova_table">[docs]</a><span class="k">def</span> <span class="nf">format_anova_table</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aov_results</span><span class="p">,</span> <span class="n">pairwise_results</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">permutations</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">max_permutations</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs p-value correction (permutation-based and FDR) and converts pandas dataframe into final format.</span>

<span class="sd">    :param df: pandas dataframe with samples as rows and protein identifiers as columns (with additional columns &#39;group&#39;, &#39;sample&#39; and &#39;subject&#39;).</span>
<span class="sd">    :param list[tuple] aov_results: list of tuples with anova results (one tuple per feature).</span>
<span class="sd">    :param list[dataframes] pairwise_results: list of pandas dataframes with posthoc tests results</span>
<span class="sd">    :param str group: column with group identifiers</span>
<span class="sd">    :param float alpha: error rate for multiple hypothesis correction</span>
<span class="sd">    :param int permutations: number of permutations used to estimate false discovery rates</span>
<span class="sd">    :param int max_permutations: maximum number of permutations according to number of samples</span>
<span class="sd">    :return: Pandas dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;F-statistics&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue&#39;</span><span class="p">]</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">aov_results</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span><span class="p">)</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;identifier&#39;</span><span class="p">)</span>

    <span class="c1">#FDR correction</span>
    <span class="k">if</span> <span class="n">permutations</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">max_permutations</span><span class="o">&gt;=</span><span class="mi">10</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">max_permutations</span> <span class="o">&lt;</span> <span class="n">permutations</span><span class="p">:</span>
            <span class="n">permutations</span> <span class="o">=</span> <span class="n">max_permutations</span>
        <span class="n">observed_pvalues</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">pvalue</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">apply_pvalue_permutation_fdrcorrection</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">observed_pvalues</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">permutations</span><span class="o">=</span><span class="n">permutations</span><span class="p">)</span>
        <span class="n">scores</span><span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;permutation FDR (</span><span class="si">{}</span><span class="s1"> perm)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">permutations</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rejected</span><span class="p">,</span> <span class="n">padj</span> <span class="o">=</span> <span class="n">apply_pvalue_fdrcorrection</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;indep&#39;</span><span class="p">)</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;FDR correction BH&#39;</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;padj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">padj</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">pairwise_results</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scores</span><span class="p">[[</span><span class="s1">&#39;F-statistics&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue&#39;</span><span class="p">,</span> <span class="s1">&#39;padj&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;correction&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">scores</span>
        <span class="n">res</span><span class="p">[</span><span class="s2">&quot;log2FC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;rejected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;padj&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">alpha</span>
    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;-log10 pvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;padj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="run_ttest"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_ttest">[docs]</a><span class="k">def</span> <span class="nf">run_ttest</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">condition1</span><span class="p">,</span> <span class="n">condition2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">drop_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">],</span> <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">paired</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">correction</span><span class="o">=</span><span class="s1">&#39;indep&#39;</span><span class="p">,</span> <span class="n">permutations</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs t-test (paired/unpaired) for each protein in dataset and performs permutation-based (if permutations&gt;0) or Benjamini/Hochberg (if permutations=0) multiple hypothesis correction.</span>

<span class="sd">    :param df: pandas dataframe with samples as rows and protein identifiers as columns (with additional columns &#39;group&#39;, &#39;sample&#39; and &#39;subject&#39;).</span>
<span class="sd">    :param str condition1: first of two conditions of the independent variable</span>
<span class="sd">    :param str condition2: second of two conditions of the independent variable</span>
<span class="sd">    :param str subject: column with subject identifiers</span>
<span class="sd">    :param str group: column with group identifiers (independent variable)</span>
<span class="sd">    :param list drop_cols: column labels to be dropped from the dataframe</span>
<span class="sd">    :param bool paired: paired or unpaired samples</span>
<span class="sd">    :param str correction: method of pvalue correction for false discovery rate (&#39;indep&#39;, &#39;negcorr&#39;)</span>
<span class="sd">    :param float alpha: error rate for multiple hypothesis correction</span>
<span class="sd">    :param int permutations: number of permutations used to estimate false discovery rates.</span>
<span class="sd">    :return: Pandas dataframe with columns &#39;identifier&#39;, &#39;group1&#39;, &#39;group2&#39;, &#39;mean(group1)&#39;, &#39;mean(group2)&#39;, &#39;Log2FC&#39;, &#39;FC&#39;, &#39;rejected&#39;, &#39;T-statistics&#39;, &#39;p-value&#39;, &#39;correction&#39;, &#39;-log10 p-value&#39;, and &#39;method&#39;.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = run_ttest(df, condition1=&#39;group1&#39;, condition2=&#39;group2&#39;, alpha = 0.05, drop_cols=[&#39;sample&#39;], subject=&#39;subject&#39;, group=&#39;group&#39;, paired=False, correction=&#39;indep&#39;, permutations=50)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;T-statistics&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_group1&#39;</span><span class="p">,</span> <span class="s1">&#39;mean_group2&#39;</span><span class="p">,</span> <span class="s1">&#39;log2FC&#39;</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="n">group</span><span class="p">,</span> <span class="n">subject</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">paired</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;Paired t-test&#39;</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func</span> <span class="o">=</span> <span class="n">calculate_paired_ttest</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span><span class="p">(</span><span class="n">condition1</span><span class="p">,</span> <span class="n">condition2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;Unpaired t-test&#39;</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func</span> <span class="o">=</span> <span class="n">calculate_ttest</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span><span class="p">(</span><span class="n">condition1</span><span class="p">,</span> <span class="n">condition2</span><span class="p">))</span>
    <span class="n">scores</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>

    <span class="n">max_perm</span> <span class="o">=</span> <span class="n">get_max_permutations</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
    <span class="c1">#FDR correction</span>
    <span class="k">if</span> <span class="n">permutations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">max_perm</span> <span class="o">&lt;</span> <span class="n">permutations</span><span class="p">:</span>
            <span class="n">permutations</span> <span class="o">=</span> <span class="n">max_perm</span>
        <span class="n">observed_pvalues</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">pvalue</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">apply_pvalue_permutation_fdrcorrection</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">observed_pvalues</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">permutations</span><span class="o">=</span><span class="n">permutations</span><span class="p">)</span>
        <span class="n">scores</span><span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;permutation FDR (</span><span class="si">{}</span><span class="s1"> perm)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">permutations</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rejected</span><span class="p">,</span> <span class="n">padj</span> <span class="o">=</span> <span class="n">apply_pvalue_fdrcorrection</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;indep&#39;</span><span class="p">)</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;FDR correction BH&#39;</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;padj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">padj</span>
        <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;rejected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rejected</span>
    <span class="c1">#scores[&#39;rejected&#39;] = scores[&#39;padj&#39;] &lt;= alpha</span>
    <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;group1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition1</span>
    <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;group2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition2</span>
    <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;FC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;log2FC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
    <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;-log10 pvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;padj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
    <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;Method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">scores</span></div>

<div class="viewcode-block" id="run_samr"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_samr">[docs]</a><span class="k">def</span> <span class="nf">run_samr</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">drop_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">s0</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">permutations</span><span class="o">=</span><span class="mi">250</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Python adaptation of the &#39;samr&#39; R package for statistical tests with permutation-based correction and s0 parameter.</span>
<span class="sd">    For more information visit https://cran.r-project.org/web/packages/samr/samr.pdf.</span>

<span class="sd">    :param df: pandas dataframe with samples as rows and protein identifiers as columns (with additional columns &#39;group&#39;, &#39;sample&#39; and &#39;subject&#39;).</span>
<span class="sd">    :param str subject: column with subject identifiers</span>
<span class="sd">    :param str group: column with group identifiers</span>
<span class="sd">    :param list drop_cols: columnlabels to be dropped from the dataframe</span>
<span class="sd">    :param float alpha: error rate for multiple hypothesis correction</span>
<span class="sd">    :param float s0: exchangeability factor for denominator of test statistic</span>
<span class="sd">    :param int permutations: number of permutations used to estimate false discovery rates. If number of permutations is equal to zero, the function will run anova with FDR Benjamini/Hochberg correction.</span>
<span class="sd">    :return: Pandas dataframe with columns &#39;identifier&#39;, &#39;group1&#39;, &#39;group2&#39;, &#39;mean(group1)&#39;, &#39;mean(group2)&#39;, &#39;Log2FC&#39;, &#39;FC&#39;, &#39;T-statistics&#39;, &#39;p-value&#39;, &#39;padj&#39;, &#39;correction&#39;, &#39;-log10 p-value&#39;, &#39;rejected&#39; and &#39;method&#39;</span>

<span class="sd">    Example::</span>

<span class="sd">        result = run_samr(df, subject=&#39;subject&#39;, group=&#39;group&#39;, drop_cols=[&#39;subject&#39;, &#39;sample&#39;], alpha=0.05, s0=1, permutations=250)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">r_installation</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No valid installation of R&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">permutations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">R_function</span> <span class="o">=</span> <span class="n">R</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;result &lt;- function(data, res_type, s0, nperms) {</span>
<span class="s1">                                    samr(data=data, resp.type=res_type, s0=s0, nperms=nperms, random.seed = 12345, s0.perc=NULL)</span>
<span class="s1">                                    }&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="n">paired</span> <span class="o">=</span> <span class="n">check_is_paired</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">group</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">conditions</span><span class="p">)}</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="n">item</span><span class="p">)</span>  <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;Multiclass&#39;</span>

        <span class="k">if</span> <span class="n">subject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;One class&#39;</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">paired</span><span class="p">:</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;Two class paired&#39;</span>
                    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">conditions</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">cur_count</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">cur_count</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="n">conditions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="p">(</span><span class="n">cur_count</span><span class="o">+</span><span class="mi">1</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">counts</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_count</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;Two class unpaired&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;Multiclass&#39;</span>

        <span class="n">delta</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">base</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="n">base</span><span class="o">.</span><span class="n">unlist</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">geneid</span><span class="o">=</span><span class="n">base</span><span class="o">.</span><span class="n">unlist</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">logged2</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s0</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">s0</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span><span class="p">:</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">ro</span><span class="o">.</span><span class="n">r</span><span class="p">(</span><span class="s2">&quot;NULL&quot;</span><span class="p">)</span>
        <span class="n">samr_res</span> <span class="o">=</span> <span class="n">R_function</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">res_type</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">s0</span><span class="o">=</span><span class="n">s0</span><span class="p">,</span> <span class="n">nperms</span><span class="o">=</span><span class="n">permutations</span><span class="p">)</span>
        <span class="n">delta_table</span> <span class="o">=</span> <span class="n">samr</span><span class="o">.</span><span class="n">samr_compute_delta_table</span><span class="p">(</span><span class="n">samr_res</span><span class="p">)</span>
        <span class="n">siggenes_table</span> <span class="o">=</span> <span class="n">samr</span><span class="o">.</span><span class="n">samr_compute_siggenes_table</span><span class="p">(</span><span class="n">samr_res</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">delta_table</span><span class="p">,</span> <span class="n">all_genes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">nperms_run</span> <span class="o">=</span> <span class="n">samr_res</span><span class="p">[</span><span class="mi">8</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">s0_used</span> <span class="o">=</span> <span class="n">samr_res</span><span class="p">[</span><span class="mi">13</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">f_stats</span> <span class="o">=</span> <span class="n">samr_res</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">pvalues</span> <span class="o">=</span> <span class="n">samr</span><span class="o">.</span><span class="n">samr_pvalues_from_perms</span><span class="p">(</span><span class="n">samr_res</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">samr_res</span><span class="p">[</span><span class="mi">21</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">siggenes_table</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">up</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">siggenes_table</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">siggenes_table</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">up</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">siggenes_table</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">down</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">siggenes_table</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">siggenes_table</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">down</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">total</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">up</span><span class="p">,</span> <span class="n">down</span><span class="p">])</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">total</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">total</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">qvalues</span> <span class="o">=</span> <span class="n">total</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span>
        <span class="n">qvalues</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">qvalues</span><span class="p">)</span>
        <span class="n">qvalues</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="n">total</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">qvalues</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;padj&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;One class&#39;</span><span class="p">:</span>
        <span class="c1">#     res.columns = [&#39;identifier&#39;, &#39;t-statistics&#39;, &#39;pvalue&#39;, &#39;padj&#39;]</span>
            <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;Multiclass&#39;</span><span class="p">:</span>
            <span class="n">pairwise_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                <span class="n">thsd_result</span> <span class="o">=</span> <span class="n">calculate_THSD</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">thsd_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pairwise_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thsd_result</span><span class="p">)</span>
            <span class="n">pairwise</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">pairwise_results</span><span class="p">)</span>

            <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">f_stats</span><span class="p">,</span> <span class="n">pvalues</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">res</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;SAMR test statistics&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue&#39;</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pairwise</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;identifier&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

            <span class="n">contrasts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;diff_mean_group</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">)))]</span>
            <span class="n">df2</span> <span class="o">=</span> <span class="n">total</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df2</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">total</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">df2</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">contrasts</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">log2FC</span> <span class="o">=</span> <span class="n">samr_res</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">log2FC</span><span class="p">,</span> <span class="n">f_stats</span><span class="p">,</span> <span class="n">pvalues</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">res</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
            <span class="n">group1</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">group2</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">mean1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mean2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group2</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">mean1</span><span class="p">,</span> <span class="n">mean2</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">rsuffix</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">res</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;log2FC&#39;</span><span class="p">,</span> <span class="s1">&#39;SAMR test statistics&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue&#39;</span><span class="p">,</span> <span class="s1">&#39;mean(group1)&#39;</span><span class="p">,</span> <span class="s1">&#39;mean(group2)&#39;</span><span class="p">]</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;group1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group1</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;group2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group2</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;FC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;log2FC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[[</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;group1&#39;</span><span class="p">,</span> <span class="s1">&#39;group2&#39;</span><span class="p">,</span> <span class="s1">&#39;mean(group1)&#39;</span><span class="p">,</span> <span class="s1">&#39;mean(group2)&#39;</span><span class="p">,</span> <span class="s1">&#39;log2FC&#39;</span><span class="p">,</span> <span class="s1">&#39;FC&#39;</span><span class="p">,</span> <span class="s1">&#39;SAMR test statistics&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue&#39;</span><span class="p">]]</span>
            <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;identifier&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">qvalues</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;identifier&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nperms_run</span> <span class="o">&lt;</span> <span class="n">permutations</span><span class="p">:</span>
            <span class="n">rejected</span><span class="p">,</span> <span class="n">padj</span> <span class="o">=</span> <span class="n">apply_pvalue_fdrcorrection</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;indep&#39;</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;padj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">padj</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;FDR correction BH&#39;</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;Note&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Maximum number of permutations: </span><span class="si">{}</span><span class="s1">. Corrected instead using FDR correction BH&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nperms_run</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;permutation FDR (</span><span class="si">{}</span><span class="s1"> perm)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nperms_run</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;rejected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;padj&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">alpha</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;-log10 pvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;pvalue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;Method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SAMR </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;s0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s0_used</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">run_anova</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">drop_cols</span><span class="o">=</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">permutations</span><span class="o">=</span><span class="n">permutations</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span><span class="c1">#, df2</span></div>


<div class="viewcode-block" id="run_fisher"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_fisher">[docs]</a><span class="k">def</span> <span class="nf">run_fisher</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;         annotated   not-annotated</span>
<span class="sd">        group1      a               b</span>
<span class="sd">        group2      c               d</span>
<span class="sd">        ------------------------------------</span>

<span class="sd">        group1 = [a, b]</span>
<span class="sd">        group2 = [c, d]</span>

<span class="sd">        odds, pvalue = stats.fisher_exact([[a, b], [c, d]])</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">odds</span><span class="p">,</span> <span class="n">pvalue</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">fisher_exact</span><span class="p">([</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">],</span> <span class="n">alternative</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">odds</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">)</span></div>

<div class="viewcode-block" id="run_regulation_enrichment"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_regulation_enrichment">[docs]</a><span class="k">def</span> <span class="nf">run_regulation_enrichment</span><span class="p">(</span><span class="n">regulation_data</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;group1&#39;</span><span class="p">,</span> <span class="s1">&#39;group2&#39;</span><span class="p">],</span> <span class="n">annotation_col</span><span class="o">=</span><span class="s1">&#39;annotation&#39;</span><span class="p">,</span> <span class="n">reject_col</span><span class="o">=</span><span class="s1">&#39;rejected&#39;</span><span class="p">,</span> <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;fisher&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function runs a simple enrichment analysis for significantly regulated features in a dataset.</span>

<span class="sd">    :param regulation_data: pandas dataframe resulting from differential regulation analysis.</span>
<span class="sd">    :param annotation: pandas dataframe with annotations for features (columns: &#39;annotation&#39;, &#39;identifier&#39; (feature identifiers), and &#39;source&#39;).</span>
<span class="sd">    :param str identifier: name of the column from annotation containing feature identifiers.</span>
<span class="sd">    :param list groups: column names from regulation_data containing group identifiers.</span>
<span class="sd">    :param str annotation_col: name of the column from annotation containing annotation terms.</span>
<span class="sd">    :param str reject_col: name of the column from regulatio_data containing boolean for rejected null hypothesis.</span>
<span class="sd">    :param str group_col: column name for new column in annotation dataframe determining if feature belongs to foreground or background.</span>
<span class="sd">    :param str method: method used to compute enrichment (only &#39;fisher&#39; is supported currently).</span>
<span class="sd">    :return: Pandas dataframe with columns: &#39;terms&#39;, &#39;identifiers&#39;, &#39;foreground&#39;, &#39;background&#39;, &#39;pvalue&#39;, &#39;padj&#39; and &#39;rejected&#39;.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = run_regulation_enrichment(regulation_data, annotation, identifier=&#39;identifier&#39;, groups=[&#39;group1&#39;, &#39;group2&#39;], annotation_col=&#39;annotation&#39;, reject_col=&#39;rejected&#39;, group_col=&#39;group&#39;, method=&#39;fisher&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">foreground_list</span> <span class="o">=</span> <span class="n">regulation_data</span><span class="p">[</span><span class="n">regulation_data</span><span class="p">[</span><span class="n">reject_col</span><span class="p">]][</span><span class="n">identifier</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">background_list</span> <span class="o">=</span> <span class="n">regulation_data</span><span class="p">[</span><span class="o">~</span><span class="n">regulation_data</span><span class="p">[</span><span class="n">reject_col</span><span class="p">]][</span><span class="n">identifier</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">grouping</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">[</span><span class="n">identifier</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">foreground_list</span><span class="p">:</span>
            <span class="n">grouping</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;foreground&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">background_list</span><span class="p">:</span>
            <span class="n">grouping</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;background&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grouping</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">annotation</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouping</span>
    <span class="n">annotation</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">group_col</span><span class="p">])</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">run_enrichment</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s1">&#39;foreground&#39;</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="s1">&#39;background&#39;</span><span class="p">,</span> <span class="n">foreground_pop</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">foreground_list</span><span class="p">),</span> <span class="n">background_pop</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">background_list</span><span class="p">),</span> <span class="n">annotation_col</span><span class="o">=</span><span class="n">annotation_col</span><span class="p">,</span> <span class="n">group_col</span><span class="o">=</span><span class="n">group_col</span><span class="p">,</span> <span class="n">identifier_col</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="run_enrichment"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_enrichment">[docs]</a><span class="k">def</span> <span class="nf">run_enrichment</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">foreground</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">foreground_pop</span><span class="p">,</span> <span class="n">background_pop</span><span class="p">,</span> <span class="n">annotation_col</span><span class="o">=</span><span class="s1">&#39;annotation&#39;</span><span class="p">,</span> <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">identifier_col</span><span class="o">=</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;fisher&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes enrichment of the foreground relative to a given backgroung, using Fisher&#39;s exact test, and corrects for multiple hypothesis testing.</span>

<span class="sd">    :param data: pandas dataframe with annotations for dataset features (columns: &#39;annotation&#39;, &#39;identifier&#39;, &#39;source&#39;, &#39;group&#39;).</span>
<span class="sd">    :param str foreground: group identifier of features that belong to the foreground.</span>
<span class="sd">    :param str background: group identifier of features that belong to the background.</span>
<span class="sd">    :param int foreground_pop: number of features in the foreground population.</span>
<span class="sd">    :param int background_pop: number of features in the background population.</span>
<span class="sd">    :param str annotation_col: name of the column containing annotation terms.</span>
<span class="sd">    :param str group_col: name of column containing the group identifiers.</span>
<span class="sd">    :param str identifier_col: name of column containing dependent variables identifiers.</span>
<span class="sd">    :param str method: method used to compute enrichment (only &#39;fisher&#39; is supported currently).</span>
<span class="sd">    :return: Pandas dataframe with annotation terms, features, number of foregroung/background features in each term, p-values and corrected p-values (columns: &#39;terms&#39;, &#39;identifiers&#39;, &#39;foreground&#39;, &#39;background&#39;, &#39;pvalue&#39;, &#39;padj&#39; and &#39;rejected&#39;).</span>

<span class="sd">    Example::</span>

<span class="sd">        result = run_enrichment(data, foreground=&#39;foreground&#39;, background=&#39;background&#39;, foreground_pop=len(foreground_list), background_pop=len(background_list), annotation_col=&#39;annotation&#39;, group_col=&#39;group&#39;, identifier_col=&#39;identifier&#39;, method=&#39;fisher&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">terms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pvalues</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fnum</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bnum</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">countsdf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">annotation_col</span><span class="p">,</span><span class="n">group_col</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;count&#39;</span><span class="p">])[(</span><span class="n">identifier_col</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">countsdf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">annotation_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">countsdf</span><span class="p">[</span><span class="n">countsdf</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">foreground</span><span class="p">][</span><span class="n">annotation_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">countsdf</span><span class="p">[</span><span class="n">countsdf</span><span class="p">[</span><span class="n">annotation_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">annotation</span><span class="p">]</span>
        <span class="n">num_foreground</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">counts</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">foreground</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">num_background</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">counts</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">background</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">num_foreground</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">num_foreground</span> <span class="o">=</span> <span class="n">num_foreground</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">num_background</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">num_background</span> <span class="o">=</span> <span class="n">num_background</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_background</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;fisher&#39;</span><span class="p">:</span>
            <span class="n">odds</span><span class="p">,</span> <span class="n">pvalue</span> <span class="o">=</span> <span class="n">run_fisher</span><span class="p">([</span><span class="n">num_foreground</span><span class="p">,</span> <span class="n">foreground_pop</span><span class="o">-</span><span class="n">num_foreground</span><span class="p">],[</span><span class="n">num_background</span><span class="p">,</span> <span class="n">background_pop</span><span class="o">-</span><span class="n">num_background</span><span class="p">])</span>
        <span class="n">fnum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num_foreground</span><span class="p">)</span>
        <span class="n">bnum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num_background</span><span class="p">)</span>
        <span class="n">terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
        <span class="n">pvalues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pvalue</span><span class="p">)</span>
        <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="n">annotation_col</span><span class="p">]</span><span class="o">==</span><span class="n">annotation</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">foreground</span><span class="p">),</span> <span class="n">identifier_col</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvalues</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">rejected</span><span class="p">,</span> <span class="n">padj</span> <span class="o">=</span> <span class="n">apply_pvalue_fdrcorrection</span><span class="p">(</span><span class="n">pvalues</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;indep&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;terms&#39;</span><span class="p">:</span><span class="n">terms</span><span class="p">,</span> <span class="s1">&#39;identifiers&#39;</span><span class="p">:</span><span class="n">ids</span><span class="p">,</span> <span class="s1">&#39;foreground&#39;</span><span class="p">:</span><span class="n">fnum</span><span class="p">,</span> <span class="s1">&#39;background&#39;</span><span class="p">:</span><span class="n">bnum</span><span class="p">,</span> <span class="s1">&#39;pvalue&#39;</span><span class="p">:</span><span class="n">pvalues</span><span class="p">,</span> <span class="s1">&#39;padj&#39;</span><span class="p">:</span><span class="n">padj</span><span class="p">,</span> <span class="s1">&#39;rejected&#39;</span><span class="p">:</span><span class="n">rejected</span><span class="p">})</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;padj&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="calculate_fold_change"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.calculate_fold_change">[docs]</a><span class="k">def</span> <span class="nf">calculate_fold_change</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">condition1</span><span class="p">,</span> <span class="n">condition2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates fold-changes between two groups for all proteins in a dataframe.</span>

<span class="sd">    :param df: pandas dataframe with samples as rows and protein identifiers as columns.</span>
<span class="sd">    :param str condition1: identifier of first group.</span>
<span class="sd">    :param str condition2: identifier of second group.</span>
<span class="sd">    :return: Numpy array.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = calculate_fold_change(data, &#39;group1&#39;, &#39;group2&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">group1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">condition1</span><span class="p">]</span>
    <span class="n">group2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">condition2</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
        <span class="n">group1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">group1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">group1</span> <span class="o">=</span> <span class="n">group1</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
        <span class="n">group2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">group2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">group2</span> <span class="o">=</span> <span class="n">group2</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">group1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">group2</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">fold_change</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fold_change</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">group1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">group2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fold_change</span></div>

<div class="viewcode-block" id="cohen_d"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.cohen_d">[docs]</a><span class="k">def</span> <span class="nf">cohen_d</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">condition1</span><span class="p">,</span> <span class="n">condition2</span><span class="p">,</span> <span class="n">ddof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates Cohen&#39;s d effect size based on the distance between two means, measured in standard deviations.</span>
<span class="sd">    For more information visit https://docs.scipy.org/doc/numpy/reference/generated/numpy.nanstd.html.</span>

<span class="sd">    :param df: pandas dataframe with samples as rows and protein identifiers as columns.</span>
<span class="sd">    :param str condition1: identifier of first group.</span>
<span class="sd">    :param str condition2: identifier of second group.</span>
<span class="sd">    :param int ddof: means Delta Degrees of Freedom.</span>
<span class="sd">    :return: Numpy array.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = cohen_d(data, &#39;group1&#39;, &#39;group2&#39;, ddof=0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">group1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">condition1</span><span class="p">]</span>
    <span class="n">group2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">condition2</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
        <span class="n">group1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">group1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">group1</span> <span class="o">=</span> <span class="n">group1</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
        <span class="n">group2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">group2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">group2</span> <span class="o">=</span> <span class="n">group2</span><span class="o">.</span><span class="n">values</span>

    <span class="n">ng1</span> <span class="o">=</span> <span class="n">group1</span><span class="o">.</span><span class="n">size</span>
    <span class="n">ng2</span> <span class="o">=</span> <span class="n">group2</span><span class="o">.</span><span class="n">size</span>
    <span class="n">dof</span> <span class="o">=</span> <span class="n">ng1</span> <span class="o">+</span> <span class="n">ng2</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">group1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">group2</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">meang1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">group1</span><span class="p">)</span>
        <span class="n">meang2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">group2</span><span class="p">)</span>
        <span class="n">sdg1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">ddof</span> <span class="o">=</span> <span class="n">ddof</span><span class="p">)</span>
        <span class="n">sdg2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">group2</span><span class="p">,</span> <span class="n">ddof</span> <span class="o">=</span> <span class="n">ddof</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">meang1</span> <span class="o">-</span> <span class="n">meang2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">ng1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span> <span class="n">sdg1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">ng2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span> <span class="n">sdg2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">dof</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="hedges_g"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.hedges_g">[docs]</a><span class="k">def</span> <span class="nf">hedges_g</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">condition1</span><span class="p">,</span> <span class="n">condition2</span><span class="p">,</span> <span class="n">ddof</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates Hedges g effect size (more accurate for sample sizes below 20 than Cohen&#39;s d).</span>
<span class="sd">    For more information visit https://docs.scipy.org/doc/numpy/reference/generated/numpy.nanstd.html.</span>

<span class="sd">    :param df: pandas dataframe with samples as rows and protein identifiers as columns.</span>
<span class="sd">    :param str condition1: identifier of first group.</span>
<span class="sd">    :param str condition2: identifier of second group.</span>
<span class="sd">    :param int ddof: means Delta Degrees of Freedom.</span>
<span class="sd">    :return: Numpy array.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = hedges_g(data, &#39;group1&#39;, &#39;group2&#39;, ddof=0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">group1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">condition1</span><span class="p">]</span>
    <span class="n">group2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">condition2</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
        <span class="n">group1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">group1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">group1</span> <span class="o">=</span> <span class="n">group1</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
        <span class="n">group2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">group2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">group2</span> <span class="o">=</span> <span class="n">group2</span><span class="o">.</span><span class="n">values</span>


    <span class="n">ng1</span> <span class="o">=</span> <span class="n">group1</span><span class="o">.</span><span class="n">size</span>
    <span class="n">ng2</span> <span class="o">=</span> <span class="n">group2</span><span class="o">.</span><span class="n">size</span>
    <span class="n">dof</span> <span class="o">=</span> <span class="n">ng1</span> <span class="o">+</span> <span class="n">ng2</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">group1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">group2</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">meang1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">group1</span><span class="p">)</span>
        <span class="n">meang2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">group2</span><span class="p">)</span>
        <span class="n">sdpooled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">]),</span> <span class="n">ddof</span> <span class="o">=</span> <span class="n">ddof</span><span class="p">)</span>

        <span class="c1">#Correct bias small sample size</span>
        <span class="k">if</span> <span class="n">ng1</span><span class="o">+</span><span class="n">ng2</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="p">((</span><span class="n">meang1</span> <span class="o">-</span> <span class="n">meang2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sdpooled</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">ng1</span><span class="o">+</span><span class="n">ng2</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ng1</span><span class="o">+</span><span class="n">ng2</span><span class="o">-</span><span class="mf">2.25</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">ng1</span><span class="o">+</span><span class="n">ng2</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ng1</span><span class="o">+</span><span class="n">ng2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="p">((</span><span class="n">meang1</span> <span class="o">-</span> <span class="n">meang2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sdpooled</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">g</span></div>

<div class="viewcode-block" id="run_mapper"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_mapper">[docs]</a><span class="k">def</span> <span class="nf">run_mapper</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lenses</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;l2norm&quot;</span><span class="p">],</span> <span class="n">n_cubes</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">linkage</span><span class="o">=</span><span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="n">affinity</span><span class="o">=</span><span class="s2">&quot;correlation&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>


<span class="sd">    :param data:</span>
<span class="sd">    :param lenses:</span>
<span class="sd">    :param n_cubes:</span>
<span class="sd">    :param overlap:</span>
<span class="sd">    :param n_clusters:</span>
<span class="sd">    :param linkage:</span>
<span class="sd">    :param affinity:</span>
<span class="sd">    :return:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">_get_numeric_data</span><span class="p">()</span>
    <span class="n">labels</span> <span class="o">=</span><span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">))}</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">IsolationForest</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">1729</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">lens1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Create another 1-D lens with L2-norm</span>
    <span class="n">mapper</span> <span class="o">=</span> <span class="n">km</span><span class="o">.</span><span class="n">KeplerMapper</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">lens2</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">lenses</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Combine both lenses to get a 2-D [Isolation Forest, L^2-Norm] lens</span>
    <span class="n">lens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">lens1</span><span class="p">,</span> <span class="n">lens2</span><span class="p">]</span>

    <span class="c1"># Define the simplicial complex</span>
    <span class="n">simplicial_complex</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">lens</span><span class="p">,</span>
                      <span class="n">X</span><span class="p">,</span>
                      <span class="n">nr_cubes</span><span class="o">=</span><span class="n">n_cubes</span><span class="p">,</span>
                      <span class="n">overlap_perc</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span>
                      <span class="n">clusterer</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">AgglomerativeClustering</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">linkage</span><span class="o">=</span><span class="n">linkage</span><span class="p">,</span> <span class="n">affinity</span><span class="o">=</span><span class="n">affinity</span><span class="p">))</span>



    <span class="k">return</span> <span class="n">simplicial_complex</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;labels&quot;</span><span class="p">:</span><span class="n">labels</span><span class="p">}</span></div>

<div class="viewcode-block" id="run_WGCNA"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_WGCNA">[docs]</a><span class="k">def</span> <span class="nf">run_WGCNA</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">drop_cols_exp</span><span class="p">,</span> <span class="n">drop_cols_cli</span><span class="p">,</span> <span class="n">RsquaredCut</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">networkType</span><span class="o">=</span><span class="s1">&#39;unsigned&#39;</span><span class="p">,</span> <span class="n">minModuleSize</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">deepSplit</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pamRespectsDendro</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">merge_modules</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">MEDissThres</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs an automated weighted gene co-expression network analysis (WGCNA), using input proteomics/transcriptomics/genomics and clinical variables data.</span>

<span class="sd">    :param dict data: dictionary of pandas dataframes with processed clinical and experimental datasets</span>
<span class="sd">    :param list drop_cols_exp: column names to be removed from the experimental dataset.</span>
<span class="sd">    :param list drop_cols_cli: column names to be removed from the clinical dataset.</span>
<span class="sd">    :param float RsquaredCut: desired minimum scale free topology fitting index R^2.</span>
<span class="sd">    :param str networkType: network type (&#39;unsigned&#39;, &#39;signed&#39;, &#39;signed hybrid&#39;, &#39;distance&#39;).</span>
<span class="sd">    :param int minModuleSize: minimum module size.</span>
<span class="sd">    :param int deepSplit: provides a rough control over sensitivity to cluster splitting, the higher the value (with &#39;hybrid&#39; method) or if True (with &#39;tree&#39; method), the more and smaller modules.</span>
<span class="sd">    :param bool pamRespectsDendro: only used for method &#39;hybrid&#39;. Objects and small modules will only be assigned to modules that belong to the same branch in the dendrogram structure.</span>
<span class="sd">    :param bool merge_modules: if True, very similar modules are merged.</span>
<span class="sd">    :param float MEDissThres: maximum dissimilarity (i.e., 1-correlation) that qualifies modules for merging.</span>
<span class="sd">    :param int verbose: integer level of verbosity. Zero means silent, higher values make the output progressively more and more verbose.</span>
<span class="sd">    :return: Tuple with multiple pandas dataframes.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = run_WGCNA(data, drop_cols_exp=[&#39;subject&#39;, &#39;sample&#39;, &#39;group&#39;, &#39;index&#39;], drop_cols_cli=[&#39;subject&#39;, &#39;biological_sample&#39;, &#39;group&#39;, &#39;index&#39;], RsquaredCut=0.8, networkType=&#39;unsigned&#39;, minModuleSize=30, deepSplit=2, pamRespectsDendro=False, merge_modules=True, MEDissThres=0.25, verbose=0)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">r_installation</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No valid installation of R&quot;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="n">wgcna</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">drop_cols_exp</span><span class="o">=</span><span class="n">drop_cols_exp</span><span class="p">,</span> <span class="n">drop_cols_cli</span><span class="o">=</span><span class="n">drop_cols_cli</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;clinical&#39;</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">:</span>
        <span class="n">data_cli</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="s1">&#39;clinical&#39;</span><span class="p">]</span>   <span class="c1">#Extract clinical data</span>
        <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;proteomics&#39;</span><span class="p">,</span> <span class="s1">&#39;rnaseq&#39;</span><span class="p">]:</span>
                <span class="n">data_exp</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>   <span class="c1">#Extract experimental data</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;wgcna-&#39;</span><span class="o">+</span><span class="n">dtype</span>
                <span class="n">result</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="n">softPower</span> <span class="o">=</span> <span class="n">wgcna</span><span class="o">.</span><span class="n">pick_softThreshold</span><span class="p">(</span><span class="n">data_exp</span><span class="p">,</span> <span class="n">RsquaredCut</span><span class="o">=</span><span class="n">RsquaredCut</span><span class="p">,</span> <span class="n">networkType</span><span class="o">=</span><span class="n">networkType</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

                <span class="n">dissTOM</span><span class="p">,</span> <span class="n">moduleColors</span> <span class="o">=</span> <span class="n">wgcna</span><span class="o">.</span><span class="n">build_network</span><span class="p">(</span><span class="n">data_exp</span><span class="p">,</span> <span class="n">softPower</span><span class="o">=</span><span class="n">softPower</span><span class="p">,</span> <span class="n">networkType</span><span class="o">=</span><span class="n">networkType</span><span class="p">,</span> <span class="n">minModuleSize</span><span class="o">=</span><span class="n">minModuleSize</span><span class="p">,</span> <span class="n">deepSplit</span><span class="o">=</span><span class="n">deepSplit</span><span class="p">,</span>
                                                    <span class="n">pamRespectsDendro</span><span class="o">=</span><span class="n">pamRespectsDendro</span><span class="p">,</span> <span class="n">merge_modules</span><span class="o">=</span><span class="n">merge_modules</span><span class="p">,</span> <span class="n">MEDissThres</span><span class="o">=</span><span class="n">MEDissThres</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

                <span class="n">Features_per_Module</span> <span class="o">=</span> <span class="n">wgcna</span><span class="o">.</span><span class="n">get_FeaturesPerModule</span><span class="p">(</span><span class="n">data_exp</span><span class="p">,</span> <span class="n">moduleColors</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;dataframe&#39;</span><span class="p">)</span>

                <span class="n">MEs</span> <span class="o">=</span> <span class="n">wgcna</span><span class="o">.</span><span class="n">calculate_module_eigengenes</span><span class="p">(</span><span class="n">data_exp</span><span class="p">,</span> <span class="n">moduleColors</span><span class="p">,</span> <span class="n">softPower</span><span class="o">=</span><span class="n">softPower</span><span class="p">,</span> <span class="n">dissimilarity</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">moduleTraitCor</span><span class="p">,</span> <span class="n">textMatrix</span> <span class="o">=</span> <span class="n">wgcna</span><span class="o">.</span><span class="n">calculate_ModuleTrait_correlation</span><span class="p">(</span><span class="n">data_exp</span><span class="p">,</span> <span class="n">data_cli</span><span class="p">,</span> <span class="n">MEs</span><span class="p">)</span>

                <span class="n">MM</span><span class="p">,</span> <span class="n">MMPvalue</span> <span class="o">=</span> <span class="n">wgcna</span><span class="o">.</span><span class="n">calculate_ModuleMembership</span><span class="p">(</span><span class="n">data_exp</span><span class="p">,</span> <span class="n">MEs</span><span class="p">)</span>

                <span class="n">FS</span><span class="p">,</span> <span class="n">FSPvalue</span> <span class="o">=</span> <span class="n">wgcna</span><span class="o">.</span><span class="n">calculate_FeatureTraitSignificance</span><span class="p">(</span><span class="n">data_exp</span><span class="p">,</span> <span class="n">data_cli</span><span class="p">)</span>

                <span class="n">METDiss</span><span class="p">,</span> <span class="n">METcor</span> <span class="o">=</span> <span class="n">wgcna</span><span class="o">.</span><span class="n">get_EigengenesTrait_correlation</span><span class="p">(</span><span class="n">MEs</span><span class="p">,</span> <span class="n">data_cli</span><span class="p">)</span>

                <span class="n">result</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="s1">&#39;dissTOM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dissTOM</span>
                <span class="n">result</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="s1">&#39;module_colors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">moduleColors</span>
                <span class="n">result</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="s1">&#39;features_per_module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Features_per_Module</span>
                <span class="n">result</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="s1">&#39;MEs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MEs</span>
                <span class="n">result</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="s1">&#39;module_trait_cor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">moduleTraitCor</span>
                <span class="n">result</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="s1">&#39;text_matrix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">textMatrix</span>
                <span class="n">result</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="s1">&#39;module_membership&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MM</span>
                <span class="n">result</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="s1">&#39;module_membership_pval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MMPvalue</span>
                <span class="n">result</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="s1">&#39;feature_significance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FS</span>
                <span class="n">result</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="s1">&#39;feature_significance_pval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FSPvalue</span>
                <span class="n">result</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="s1">&#39;ME_trait_diss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">METDiss</span>
                <span class="n">result</span><span class="p">[</span><span class="n">dtype</span><span class="p">][</span><span class="s1">&#39;ME_trait_cor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">METcor</span>

    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="most_central_edge"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.most_central_edge">[docs]</a><span class="k">def</span> <span class="nf">most_central_edge</span><span class="p">(</span><span class="n">G</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the eigenvector centrality for the graph G, and finds the highest value.</span>

<span class="sd">    :param graph G: networkx graph</span>
<span class="sd">    :return: Highest eigenvector centrality value.</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">centrality</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">eigenvector_centrality_numpy</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;width&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">centrality</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">centrality</span><span class="o">.</span><span class="n">get</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_louvain_partitions"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.get_louvain_partitions">[docs]</a><span class="k">def</span> <span class="nf">get_louvain_partitions</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">weight</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the partition of the graph nodes which maximises the modularity (or try..) using the Louvain heuristices. For more information visit https://python-louvain.readthedocs.io/en/latest/api.html.</span>

<span class="sd">    :param graph G: networkx graph which is decomposed.</span>
<span class="sd">    :param str weight: the key in graph to use as weight.</span>
<span class="sd">    :return: The partition, with communities numbered from 0 to number of communities.</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">partition</span> <span class="o">=</span> <span class="n">community</span><span class="o">.</span><span class="n">best_partition</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">partition</span></div>

<div class="viewcode-block" id="get_network_communities"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.get_network_communities">[docs]</a><span class="k">def</span> <span class="nf">get_network_communities</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds communities in a graph using different methods. For more information on the methods visit:</span>

<span class="sd">        - https://networkx.github.io/documentation/latest/reference/algorithms/generated/networkx.algorithms.community.modularity_max.greedy_modularity_communities.html</span>
<span class="sd">        - https://networkx.github.io/documentation/networkx-2.0/reference/algorithms/generated/networkx.algorithms.community.asyn_lpa.asyn_lpa_communities.html</span>
<span class="sd">        - https://networkx.github.io/documentation/latest/reference/algorithms/generated/networkx.algorithms.community.centrality.girvan_newman.html</span>
<span class="sd">        - https://networkx.github.io/documentation/latest/reference/generated/networkx.convert_matrix.to_pandas_adjacency.html</span>

<span class="sd">    :param graph graph: networkx graph</span>
<span class="sd">    :param dict args: config file arguments</span>
<span class="sd">    :return: Dictionary of nodes and which community they belong to (from 0 to number of communities).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;communities_algorithm&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;communities_algorithm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;louvain&#39;</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;communities_algorithm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;louvain&#39;</span><span class="p">:</span>
        <span class="n">communities</span> <span class="o">=</span> <span class="n">get_louvain_partitions</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;communities_algorithm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;greedy_modularity&#39;</span><span class="p">:</span>
        <span class="n">gcommunities</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">community</span><span class="o">.</span><span class="n">greedy_modularity_communities</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">])</span>
        <span class="n">communities</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">generator_to_dict</span><span class="p">(</span><span class="n">gcommunities</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;communities_algorithm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;asyn_label_propagation&#39;</span><span class="p">:</span>
        <span class="n">gcommunities</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">community</span><span class="o">.</span><span class="n">label_propagation</span><span class="o">.</span><span class="n">asyn_lpa_communities</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">])</span>
        <span class="n">communities</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">generator_to_dict</span><span class="p">(</span><span class="n">gcommunities</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;communities_algorithm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;girvan_newman&#39;</span><span class="p">:</span>
        <span class="n">gcommunities</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">community</span><span class="o">.</span><span class="n">girvan_newman</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">most_valuable_edge</span><span class="o">=</span><span class="n">most_central_edge</span><span class="p">)</span>
        <span class="n">communities</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">generator_to_dict</span><span class="p">(</span><span class="n">gcommunities</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;communities_algorithm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;affinity_propagation&#39;</span><span class="p">:</span>
        <span class="n">adjacency</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">to_pandas_adjacency</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;width&#39;</span><span class="p">)</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">adjacency</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">communities</span> <span class="o">=</span> <span class="n">AffinityPropagation</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">adjacency</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">labels_</span>
        <span class="n">communities</span> <span class="o">=</span> <span class="p">{</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">communities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">communities</span><span class="p">))}</span>


    <span class="k">return</span> <span class="n">communities</span></div>

<div class="viewcode-block" id="get_publications_abstracts"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.get_publications_abstracts">[docs]</a><span class="k">def</span> <span class="nf">get_publications_abstracts</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">publication_col</span><span class="o">=</span><span class="s2">&quot;publication&quot;</span><span class="p">,</span> <span class="n">join_by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;publication&#39;</span><span class="p">,</span><span class="s1">&#39;Proteins&#39;</span><span class="p">,</span><span class="s1">&#39;Diseases&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="s2">&quot;PMID&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Accesses NCBI PubMed over the WWW and retrieves the abstracts corresponding to a list of one or more PubMed IDs.</span>

<span class="sd">    :param data: pandas dataframe of diseases and publications linked to a list of proteins (columns: &#39;Diseases&#39;, &#39;Proteins&#39;, &#39;linkout&#39; and &#39;publication&#39;).</span>
<span class="sd">    :param str publication_col: column label containing PubMed ids.</span>
<span class="sd">    :param list join_by: column labels to be kept from the input dataframe.</span>
<span class="sd">    :param str index: column label containing PubMed ids from the NCBI retrieved data.</span>
<span class="sd">    :return: Pandas dataframe with publication information and columns &#39;PMID&#39;, &#39;abstract&#39;, &#39;authors&#39;, &#39;date&#39;, &#39;journal&#39;, &#39;keywords&#39;, &#39;title&#39;, &#39;url&#39;, &#39;Proteins&#39; and &#39;Diseases&#39;.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = get_publications_abstracts(data, publication_col=&#39;publication&#39;, join_by=[&#39;publication&#39;,&#39;Proteins&#39;,&#39;Diseases&#39;], index=&#39;PMID&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">abstracts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">abstracts</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">getMedlineAbstracts</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="n">publication_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">abstracts</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">abstracts</span> <span class="o">=</span> <span class="n">abstracts</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">abstracts</span> <span class="o">=</span> <span class="n">abstracts</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[</span><span class="n">join_by</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">publication_col</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">abstracts</span></div>

<div class="viewcode-block" id="eta_squared"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.eta_squared">[docs]</a><span class="k">def</span> <span class="nf">eta_squared</span><span class="p">(</span><span class="n">aov</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the effect size using Eta-squared.</span>

<span class="sd">    :param aov: pandas dataframe with anova results from statsmodels.</span>
<span class="sd">    :return: Pandas dataframe with additional Eta-squared column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aov</span><span class="p">[</span><span class="s1">&#39;eta_sq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NaN&#39;</span>
    <span class="n">aov</span><span class="p">[</span><span class="s1">&#39;eta_sq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aov</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;sum_sq&#39;</span><span class="p">]</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">aov</span><span class="p">[</span><span class="s1">&#39;sum_sq&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">aov</span></div>

<div class="viewcode-block" id="omega_squared"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.omega_squared">[docs]</a><span class="k">def</span> <span class="nf">omega_squared</span><span class="p">(</span><span class="n">aov</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the effect size using Omega-squared.</span>

<span class="sd">    :param aov: pandas dataframe with anova results from statsmodels.</span>
<span class="sd">    :return: Pandas dataframe with additional Omega-squared column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">aov</span><span class="p">[</span><span class="s1">&#39;sum_sq&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">aov</span><span class="p">[</span><span class="s1">&#39;df&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">aov</span><span class="p">[</span><span class="s1">&#39;omega_sq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NaN&#39;</span>
    <span class="n">aov</span><span class="p">[</span><span class="s1">&#39;omega_sq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">aov</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;sum_sq&#39;</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">aov</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;df&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">mse</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">aov</span><span class="p">[</span><span class="s1">&#39;sum_sq&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">mse</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aov</span></div>

<div class="viewcode-block" id="run_two_way_anova"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_two_way_anova">[docs]</a><span class="k">def</span> <span class="nf">run_two_way_anova</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">drop_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">],</span> <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;secondary_group&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a 2-way ANOVA when data[&#39;secondary_group&#39;] is not empty</span>

<span class="sd">    :param df: processed pandas dataframe with samples as rows, and proteins and groups as columns.</span>
<span class="sd">    :param list drop_cols: column names to drop from dataframe</span>
<span class="sd">    :param str subject: column name containing subject identifiers.</span>
<span class="sd">    :param list group: column names corresponding to independent variable groups</span>
<span class="sd">    :return: Two dataframes, anova results and residuals.</span>

<span class="sd">    Example::</span>

<span class="sd">        result = run_two_way_anova(data, drop_cols=[&#39;sample&#39;], subject=&#39;subject&#39;, group=[&#39;group&#39;, &#39;secondary_group&#39;])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">factorA</span><span class="p">,</span> <span class="n">factorB</span> <span class="o">=</span> <span class="n">group</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="n">subject</span><span class="p">]</span><span class="o">+</span><span class="n">group</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>

    <span class="n">aov_result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ols</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> ~ C(</span><span class="si">{}</span><span class="s1">)*C(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">factorA</span><span class="p">,</span> <span class="n">factorB</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]))</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">aov_table</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">anova_lm</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">eta_squared</span><span class="p">(</span><span class="n">aov_table</span><span class="p">)</span>
        <span class="n">omega_squared</span><span class="p">(</span><span class="n">aov_table</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">aov_table</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="s1">&#39;Residual&#39;</span><span class="p">:</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">omega</span> <span class="o">=</span> <span class="n">aov_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;PR(&gt;F)&#39;</span><span class="p">,</span> <span class="s1">&#39;eta_sq&#39;</span><span class="p">,</span> <span class="s1">&#39;omega_sq&#39;</span><span class="p">]]</span>
                <span class="n">protein</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="n">aov_result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">protein</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">omega</span><span class="p">))</span>
        <span class="n">residuals</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">resid</span>

    <span class="n">anova_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">aov_result</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span><span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;F-statistics&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue&#39;</span><span class="p">,</span> <span class="s1">&#39;eta_sq&#39;</span><span class="p">,</span> <span class="s1">&#39;omega_sq&#39;</span><span class="p">])</span>
    <span class="n">anova_df</span> <span class="o">=</span> <span class="n">anova_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;identifier&#39;</span><span class="p">)</span>
    <span class="n">anova_df</span> <span class="o">=</span> <span class="n">anova_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">anova_df</span><span class="p">,</span> <span class="n">residuals</span></div>

<div class="viewcode-block" id="run_snf"><a class="viewcode-back" href="../../../_autosummary/analytics_core.analytics.html#analytics_core.analytics.analytics.run_snf">[docs]</a><span class="k">def</span> <span class="nf">run_snf</span><span class="p">(</span><span class="n">df_dict</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">distance_metric</span><span class="p">,</span> <span class="n">K_affinity</span><span class="p">,</span> <span class="n">mu_affinity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    :param df_dict:</span>
<span class="sd">    :param clusters:</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Alberto Santos, Ana Rita Colao, Annelaura B. Nielsen

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>